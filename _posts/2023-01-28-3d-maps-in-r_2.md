---
title: "3D-maps-in-r"
date: 2023-01-28T14:15:00-00:00
categories:
  - blog
tags:
  - post
  - r
  - ggplot2
  - plot
  - grammar of graphics
  - figures
layout: splash
---

# 3D maps in R

The purpose of this post is to show how make a 3D map using `rayshader`. The idea is to use a DEM obtained from the SRTM mission (worldwide cover) or an available DEM from other National Institutions, such as Mexico's National Institute of Statistics and Geography to obtain a 3D relief of the area of interest; and an RGB composite to overlay it on the relief. The cloudless RGB mosaic I am using in this post was obtained from Landsat-8 images and was produced using Google Earth Engine. 

First load the libraries we are going to use

{% highlight r %}
library(rayshader)
library(raster)
library(jpeg)
{% endhighlight %}

Then, read the images.

{% highlight r %}
dem <- raster("dem_more.tif")

# Clip raster range to 98 % (taken from GEE)
rgb <- stack("rgb.tif")
{% endhighlight %}

The next step is going to clip the rgb image to the lower and upper 2 % quantiles so the image can be better appreciated and write it as JPEG.

{% highlight r %}
# Clip values
rgb[rgb < quants[1]] <- quants[1]
rgb[rgb > quants[2]] <- quants[2]
# Pass to new range (0-1) to write as jpeg
rgb <- ((rgb - quants[1])* 1/ quants[2]) + 0
# ((oldValueToConvert - oldScaleMin)* newScaleRange/ oldScaleRange) + newScaleMin

writeJPEG(as.array(rgb), "out2.jpeg")
{% endhighlight %}

Next, let's import the rgb and convert the dem into a matrix.

{% highlight r %}
rgb <- readJPEG("out2.jpeg")
# plot(rgb)

# Convert it to a matrix:
dem_mat <-  raster_to_matrix(dem)
{% endhighlight %}

Afterward, let's do the 3d rendering with the dem and rgb layers and set additional parameters for the visualization. Since I am using an RGB, I am going to omit the step of showing and detecting water bodies. However, if you do not have an available RGB, you can use this to try to differentiate water bodies in the region of interest. Additionally, if you do not have an rgb composite, you can add some shadows to the dem make the result more realistic. These parts are commented in the script, but are left for future reference.

{% highlight r %}
dem_mat %>%
  sphere_shade(texture = "bw") %>%
  # add_water(detect_water(dem_mat),
  #           color = "imhof1") %>%
  # add_shadow(ray_shade(dem_mat, zscale = 3), 0.5) %>%
  # add_shadow(ambient_shade(dem_mat), 0) %>%
  add_overlay(rgb) |>
  plot_3d(dem_mat, 
          zscale = 12, 
          fov = 0, 
          theta = 20, 
          zoom = 0.75, 
          # azimut
          phi = 45, 
          windowsize = c(1000, 800))
{% endhighlight %}

Finally, I am going to save a snapshot of the 3d model and setting some parameters.

{% highlight r %}
render_snapshot(filename = "Morelia3D.jpg",
                title_text = "Morelia, Michoacán", 
                title_color = "white", title_bar_color = "black",
                title_font = "Helvetica", gravity = "North")
{% endhighlight %}

The result:

[![styled-image]({{ site.url }}{{ site.baseurl }}/assets/images/Morelia3D.jpg){: .align-center style="width: 60%;"}]({{ site.url }}{{ site.baseurl }}/assets/images/Morelia3D.jpg) 3D map of Patzcuaro and Morelia surroundings in Michoacán, Mexico.
{: style="text-align: center; font-size:0.75em;"}

If you are familiar with the surrounding of Morelia, Michoacán, you will immediatly recognize Patzcuaro and Cuitzeo lakes, as well as some unactive volcanoes, such as the Quinceo.