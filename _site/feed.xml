<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="3.9.5">Jekyll</generator><link href="http://localhost:4000/feed.xml" rel="self" type="application/atom+xml" /><link href="http://localhost:4000/" rel="alternate" type="text/html" /><updated>2024-05-26T11:52:02-06:00</updated><id>http://localhost:4000/feed.xml</id><title type="html">Jonathan V. Solórzano</title><subtitle>Welcome to my personal site. In this site you can get to know more about my work and check some of my courses and example scripts in R and GEE.</subtitle><author><name>Jonathan V. Solórzano</name></author><entry><title type="html">Leaflet in R</title><link href="http://localhost:4000/blog/Leaflet-in-r/" rel="alternate" type="text/html" title="Leaflet in R" /><published>2023-11-10T11:42:00-06:00</published><updated>2023-11-10T11:42:00-06:00</updated><id>http://localhost:4000/blog/Leaflet-in-r</id><content type="html" xml:base="http://localhost:4000/blog/Leaflet-in-r/"><![CDATA[<h1 id="leaflet-in-r">Leaflet in R</h1>

<p>This post shows how to build beautiful interactive maps in R using leaflet.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="n">leaflet</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">sf</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">terra</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">raster</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">RColorBrewer</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">htmlwidgets</span><span class="p">)</span></code></pre></figure>

<h2 id="read-data">Read data</h2>

<p>Here I am reading three different datasets, a polygon (mx_states) and a point (caps) layer, as well as a raster (DEM).</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># States polygons</span><span class="w">
</span><span class="c1"># Data downloaded from http://www.conabio.gob.mx/informacion/gis/?vns=gis_root/dipol/estata/dest22gw</span><span class="w">
</span><span class="n">mx_states</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">st_read</span><span class="p">(</span><span class="s2">"dest22gw.shp"</span><span class="p">)</span><span class="w">
</span><span class="c1"># DEM</span><span class="w">
</span><span class="c1"># Data downloaded from: http://www.conabio.gob.mx/informacion/gis/?vns=gis_root/dipol/estata/dest22gw</span><span class="w">
</span><span class="n">dem</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rast</span><span class="p">(</span><span class="s2">"filled_demgw.tif"</span><span class="p">)</span><span class="w">
</span><span class="c1"># Capitals</span><span class="w">
</span><span class="c1"># Data downloaded from: https://www.efrainmaps.es/descargas-gratuitas/m%C3%A9xico/</span><span class="w">
</span><span class="n">caps</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">st_read</span><span class="p">(</span><span class="s2">"México_Ciudades.shp"</span><span class="p">)</span></code></pre></figure>

<h2 id="create-palettes">Create palettes</h2>

<p>Create palettes for the data. Here we are goin to use RcolorBrewer functionalities and some leaflet functions. Also, notice that I am creating two palettes for the DEM. This is a small hack to put the legend in a reverse order (low values in the lower side and higher in the upper one).</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1">## States palette</span><span class="w">
</span><span class="n">coul</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">brewer.pal</span><span class="p">(</span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="s2">"PuOr"</span><span class="p">)</span><span class="w"> 
</span><span class="n">pal_st</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">colorRampPalette</span><span class="p">(</span><span class="n">coul</span><span class="p">)(</span><span class="m">33</span><span class="p">)</span><span class="w">
</span><span class="c1">## Dem palette</span><span class="w">
</span><span class="n">coul</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">grDevices</span><span class="o">::</span><span class="n">colorRampPalette</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s2">"#026449"</span><span class="p">,</span><span class="w"> </span><span class="s2">"#12722c"</span><span class="p">,</span><span class="s2">"#d7d17e"</span><span class="p">,</span><span class="w">
                                        </span><span class="s2">"#95400d"</span><span class="p">,</span><span class="w"> </span><span class="s2">"#980802"</span><span class="p">,</span><span class="w"> </span><span class="s2">"#746c69"</span><span class="p">,</span><span class="w"> </span><span class="s2">"#f1f1f1"</span><span class="p">,</span><span class="s2">"#fdfdfd"</span><span class="p">),</span><span class="w">
                                      </span><span class="n">interpolate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"spline"</span><span class="p">,</span><span class="w">
                                      </span><span class="n">bias</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)(</span><span class="m">256</span><span class="p">)</span><span class="w">
</span><span class="n">pal_dem</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">leaflet</span><span class="o">::</span><span class="n">colorNumeric</span><span class="p">(</span><span class="w">
  </span><span class="nf">c</span><span class="p">(</span><span class="s2">"#026449"</span><span class="p">,</span><span class="w"> </span><span class="s2">"#12722c"</span><span class="p">,</span><span class="s2">"#d7d17e"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"#95400d"</span><span class="p">,</span><span class="w"> </span><span class="s2">"#980802"</span><span class="p">,</span><span class="w"> </span><span class="s2">"#746c69"</span><span class="p">,</span><span class="w"> </span><span class="s2">"#f1f1f1"</span><span class="p">,</span><span class="s2">"#fdfdfd"</span><span class="p">),</span><span class="w">
  </span><span class="n">values</span><span class="p">(</span><span class="n">dem</span><span class="p">),</span><span class="w">
  </span><span class="n">na.color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"transparent"</span><span class="p">,</span><span class="w">
  </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">,</span><span class="w">
  </span><span class="n">reverse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="w">
</span><span class="p">)</span><span class="w">
</span><span class="c1"># Palette hack to invert legend</span><span class="w">
</span><span class="n">pal_dem2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">leaflet</span><span class="o">::</span><span class="n">colorNumeric</span><span class="p">(</span><span class="w">
  </span><span class="nf">c</span><span class="p">(</span><span class="s2">"#026449"</span><span class="p">,</span><span class="w"> </span><span class="s2">"#12722c"</span><span class="p">,</span><span class="s2">"#d7d17e"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"#95400d"</span><span class="p">,</span><span class="w"> </span><span class="s2">"#980802"</span><span class="p">,</span><span class="w"> </span><span class="s2">"#746c69"</span><span class="p">,</span><span class="w"> </span><span class="s2">"#f1f1f1"</span><span class="p">,</span><span class="s2">"#fdfdfd"</span><span class="p">),</span><span class="w">
  </span><span class="n">values</span><span class="p">(</span><span class="n">dem</span><span class="p">),</span><span class="w">
  </span><span class="n">na.color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"transparent"</span><span class="p">,</span><span class="w">
  </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">,</span><span class="w">
  </span><span class="n">reverse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="w">
</span><span class="p">)</span><span class="w">
</span><span class="c1">## Capitals palette, same as states</span></code></pre></figure>

<h2 id="leaflet-map">Leaflet map</h2>

<p>Then create the leaflet map. First let’s add the polygons.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">mapa</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">leaflet</span><span class="o">::</span><span class="n">leaflet</span><span class="p">()</span><span class="w">

</span><span class="c1">## Add Polygons</span><span class="w">
</span><span class="n">mapa</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">mapa</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
    </span><span class="n">leaflet</span><span class="o">::</span><span class="n">addPolygons</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mx_states</span><span class="p">,</span><span class="w">
                         </span><span class="n">stroke</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> 
                         </span><span class="n">smoothFactor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">,</span><span class="w"> 
                         </span><span class="n">opacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w">
                         </span><span class="n">fillOpacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.9</span><span class="p">,</span><span class="w">
                         </span><span class="n">fillColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">pal_st</span><span class="p">,</span><span class="w">
                         </span><span class="n">weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="m">0.2</span><span class="p">,</span><span class="w">
                         </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="s2">"black"</span><span class="p">,</span><span class="w">
                         </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"States"</span><span class="p">,</span><span class="w">
                         </span><span class="n">popup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="n">mx_states</span><span class="o">$</span><span class="n">NOMGEO</span><span class="p">)</span></code></pre></figure>

<p>Add the raster. Here notice the use of <code class="language-plaintext highlighter-rouge">pal_dem2</code> in <code class="language-plaintext highlighter-rouge">addLegend</code> and sort the values in decreasing order using <code class="language-plaintext highlighter-rouge">labFormat</code>.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1">## Get tange of dem</span><span class="w">
</span><span class="n">minmax</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">range</span><span class="p">(</span><span class="n">raster</span><span class="o">::</span><span class="n">values</span><span class="p">(</span><span class="n">dem</span><span class="p">)[</span><span class="o">!</span><span class="nf">is.na</span><span class="p">(</span><span class="n">raster</span><span class="o">::</span><span class="n">values</span><span class="p">(</span><span class="n">dem</span><span class="p">))])</span><span class="w">

</span><span class="c1">## Add raster</span><span class="w">
</span><span class="n">mapa</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">mapa</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">leaflet</span><span class="o">::</span><span class="n">addRasterImage</span><span class="p">(</span><span class="n">raster</span><span class="o">::</span><span class="n">raster</span><span class="p">(</span><span class="n">dem</span><span class="p">),</span><span class="w"> 
                          </span><span class="n">colors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pal_dem</span><span class="p">,</span><span class="w"> 
                          </span><span class="n">opacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.9</span><span class="p">,</span><span class="w">  
                          </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"DEM"</span><span class="p">,</span><span class="w">
                          </span><span class="n">layerId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"DEM"</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">leaflet</span><span class="o">::</span><span class="n">addLegend</span><span class="p">(</span><span class="n">position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"bottomleft"</span><span class="p">,</span><span class="w"> 
                     </span><span class="n">pal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pal_dem2</span><span class="p">,</span><span class="w"> 
                     </span><span class="n">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">seq</span><span class="p">(</span><span class="n">minmax</span><span class="p">[</span><span class="m">1</span><span class="p">],</span><span class="w"> </span><span class="n">minmax</span><span class="p">[</span><span class="m">2</span><span class="p">],</span><span class="w"> </span><span class="m">100</span><span class="p">),</span><span class="w"> </span><span class="c1">#4 categorical maps terra::levels(dem)[[1]]$ID,</span><span class="w">
                     </span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Elevación m s.n.m"</span><span class="p">,</span><span class="w">
                     </span><span class="n">labFormat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">labelFormat</span><span class="p">(</span><span class="n">transform</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="n">sort</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">decreasing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)))</span><span class="w">
                    </span><span class="c1"># for categorical maps</span><span class="w">
                     </span><span class="c1"># labFormat =  leaflet::labelFormat(</span><span class="w">
                     </span><span class="c1">#   transform = function(x) {</span><span class="w">
                     </span><span class="c1">#     df_eq %&gt;%</span><span class="w">
                     </span><span class="c1">#       dplyr::filter(ID == x) %&gt;%</span><span class="w">
                     </span><span class="c1">#       dplyr::pull(!!sym(key)) </span><span class="w">
                     </span><span class="c1">#   })) </span></code></pre></figure>

<p>Add the points. Here I set a different color to the circle inside the marker.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1">## Points</span><span class="w">
</span><span class="c1">### Create customized markers</span><span class="w">
</span><span class="c1">### Can create in several lists, that's why two lapply are used</span><span class="w">
</span><span class="c1">### In this case we really only need one level</span><span class="w">
</span><span class="n">resul</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lapply</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">pal_st</span><span class="p">),</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">j</span><span class="p">){</span><span class="w">
    </span><span class="n">leaflet</span><span class="o">::</span><span class="n">makeAwesomeIcon</span><span class="p">(</span><span class="w">
      </span><span class="n">icon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"circle"</span><span class="p">,</span><span class="w">
      </span><span class="n">library</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"fa"</span><span class="p">,</span><span class="w">
      </span><span class="n">iconColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pal_st</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="w">
      </span><span class="n">markerColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"white"</span><span class="p">,</span><span class="w">
      
    </span><span class="p">)</span><span class="w">
  </span><span class="p">})</span><span class="w"> 
</span><span class="c1"># Cast as awesome icon list</span><span class="w">
</span><span class="n">resul</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">structure</span><span class="p">(</span><span class="n">resul</span><span class="p">,</span><span class="w"> </span><span class="n">class</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"leaflet_awesome_icon_set"</span><span class="p">)</span><span class="w">

</span><span class="c1">## Add points</span><span class="w">
</span><span class="n">mapa</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">mapa</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
    </span><span class="n">leaflet</span><span class="o">::</span><span class="n">addAwesomeMarkers</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">caps</span><span class="p">,</span><span class="w"> 
                               </span><span class="n">icon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">resul</span><span class="p">,</span><span class="w">
                               </span><span class="n">popup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="n">caps</span><span class="o">$</span><span class="n">CIUDAD</span><span class="p">,</span><span class="w">
                               </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Capitals"</span><span class="p">)</span></code></pre></figure>

<p>Add three Esri basemaps</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1">## Base maps</span><span class="w">
</span><span class="n">mapas_base</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"Esri.WorldTopoMap"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Esri.WorldImagery"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Esri.WorldGrayCanvas"</span><span class="p">)</span><span class="w">

</span><span class="c1"># Add basemaps</span><span class="w">
</span><span class="k">for</span><span class="p">(</span><span class="n">provider</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">mapas_base</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">mapa</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">mapa</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
    </span><span class="n">leaflet</span><span class="o">::</span><span class="n">addProviderTiles</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span><span class="w"> 
                              </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">provider</span><span class="p">)</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<p>Add controls and mini map. <code class="language-plaintext highlighter-rouge">OverlayGroups</code> should match the name given for each layer in the previous sections.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># Add controls and mini map</span><span class="w">
</span><span class="n">mapa</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">mapa</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">leaflet</span><span class="o">::</span><span class="n">addLayersControl</span><span class="p">(</span><span class="n">overlayGroups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"States"</span><span class="p">,</span><span class="w"> </span><span class="s2">"DEM"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Capitals"</span><span class="p">),</span><span class="w">
                            </span><span class="n">baseGroups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mapas_base</span><span class="p">,</span><span class="w">
                            </span><span class="n">position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"topright"</span><span class="p">,</span><span class="w">
                            </span><span class="n">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">leaflet</span><span class="o">::</span><span class="n">layersControlOptions</span><span class="p">(</span><span class="n">collapsed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">,</span><span class="w">
                                                                    </span><span class="n">hideSingleBase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">leaflet</span><span class="o">::</span><span class="n">addMiniMap</span><span class="p">(</span><span class="n">tiles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mapas_base</span><span class="p">[[</span><span class="m">1</span><span class="p">]],</span><span class="w"> 
                      </span><span class="n">toggleDisplay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w">
                      </span><span class="n">position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"bottomleft"</span><span class="p">)</span><span class="w"> </span></code></pre></figure>

<p>Add more customizations: change base map, zoom to extent of layers, add globe button to reset zoom level to the 
starting point, add opacity slider.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># More customizations</span><span class="w">
</span><span class="n">mapa</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">mapa</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="c1"># update base map</span><span class="w">
  </span><span class="n">htmlwidgets</span><span class="o">::</span><span class="n">onRender</span><span class="p">(</span><span class="s2">"
    function(el, x) {
      var myMap = this;
      myMap.on('baselayerchange',
        function (e) {
          myMap.minimap.changeLayer(L.tileLayer.provider(e.name));
        })
    }"</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="c1"># add full extent button</span><span class="w">
  </span><span class="n">leaflet</span><span class="o">::</span><span class="n">addEasyButton</span><span class="p">(</span><span class="n">leaflet</span><span class="o">::</span><span class="n">easyButton</span><span class="p">(</span><span class="w">
    </span><span class="n">icon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"fa-globe"</span><span class="p">,</span><span class="w"> 
    </span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Zoom to Level 1"</span><span class="p">,</span><span class="w">
    </span><span class="n">onClick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">leaflet</span><span class="o">::</span><span class="n">JS</span><span class="p">(</span><span class="s2">"function(btn, map){ map.fitBounds([
                                        ["</span><span class="p">,</span><span class="w"> </span><span class="m">14.55712</span><span class="p">,</span><span class="w"> </span><span class="s2">","</span><span class="p">,</span><span class="w"> </span><span class="m">-117.12579</span><span class="p">,</span><span class="w"> </span><span class="s2">"], "</span><span class="p">,</span><span class="w">
                          </span><span class="s2">"["</span><span class="p">,</span><span class="w"> </span><span class="m">32.71876</span><span class="p">,</span><span class="w"> </span><span class="s2">","</span><span class="p">,</span><span class="w"> </span><span class="m">-86.74011</span><span class="p">,</span><span class="w"> </span><span class="s2">"]
                                        ]); }"</span><span class="p">)))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="c1"># opacity slider</span><span class="w">
  </span><span class="n">leaflet</span><span class="o">::</span><span class="n">addControl</span><span class="p">(</span><span class="n">html</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"&lt;input id=\"OpacitySlide\" type=\"range\" min=\"0\" max=\"1\" step=\"0.1\" value=\"0.5\"&gt;"</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="c1"># change opacity of the layers</span><span class="w">
  </span><span class="n">htmlwidgets</span><span class="o">::</span><span class="n">onRender</span><span class="p">(</span><span class="w">
    </span><span class="s2">"function(el,x,data){
                     var map = this;
                     var evthandler = function(e){
                        var layers = map.layerManager.getVisibleGroups();
                        console.log('VisibleGroups: ', layers); 
                        console.log('Target value: ', +e.target.value);
                        layers.forEach(function(group) {
                          var layer = map.layerManager._byGroup[group];
                          console.log('currently processing: ', group);
                          Object.keys(layer).forEach(function(el){
                            if(layer[el] instanceof L.Polygon){;
                            console.log('Change opacity of: ', group, el);
                             layer[el].setStyle({fillOpacity:+e.target.value});
                            }
                          });
                        })
                     };
              $('#OpacitySlide').mousedown(function () { map.dragging.disable(); });
              $('#OpacitySlide').mouseup(function () { map.dragging.enable(); });
              $('#OpacitySlide').on('input', evthandler)}
          "</span><span class="p">)</span></code></pre></figure>

<p>Save file as html widget.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">htmlwidgets</span><span class="o">::</span><span class="n">saveWidget</span><span class="p">(</span><span class="n">mapa</span><span class="p">,</span><span class="w"> 
                        </span><span class="s2">"Map1.html"</span><span class="p">)</span></code></pre></figure>

<p>The final result (click on the following image to access the map):</p>

<p style="text-align: center; font-size:0.75em;"><a href="http://localhost:4000/assets/leaflet/Map1.html"><img src="http://localhost:4000/assets/images/leafletmap.png" alt="map" class="align-center" style="width: 80%;" /></a> Interactive leaflet map.</p>]]></content><author><name>Jonathan V. Solórzano</name></author><category term="blog" /><category term="post" /><category term="r" /><category term="maps" /><category term="interactive maps" /><category term="leaflet" /><category term="html maps" /><summary type="html"><![CDATA[Leaflet in R]]></summary></entry><entry><title type="html">AGB forest sampling calculations</title><link href="http://localhost:4000/blog/AGB-forest-sampling-calculations/" rel="alternate" type="text/html" title="AGB forest sampling calculations" /><published>2023-07-17T11:42:00-06:00</published><updated>2023-07-17T11:42:00-06:00</updated><id>http://localhost:4000/blog/AGB-forest-sampling-calculations</id><content type="html" xml:base="http://localhost:4000/blog/AGB-forest-sampling-calculations/"><![CDATA[<h1 id="agb-forest-sampling-calculations">AGB forest sampling calculations</h1>

<p>This post shows an example of how to calculate some common plot-level variables from a forest sampling.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="n">BIOMASS</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">stringr</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">tidyverse</span><span class="p">)</span></code></pre></figure>

<p>Read data</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># Field data with individual tree measures</span><span class="w">
</span><span class="n">df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.csv</span><span class="p">(</span><span class="s2">"D:/Drive/Jonathan_trabaggio/Doctorado/R/Ayuquila_Degradation/CleanData/df_all.csv"</span><span class="p">,</span><span class="w">
               </span><span class="n">na.strings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"NA"</span><span class="p">)</span><span class="w">

</span><span class="c1"># Coordinates of each site.</span><span class="w">
</span><span class="n">coords</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.csv</span><span class="p">(</span><span class="s2">"D:/Drive/Jonathan_trabaggio/Doctorado/R/Ayuquila_Degradation/Data/gpscoords.csv"</span><span class="p">)</span></code></pre></figure>

<p>How the headers of the data look like the following for the <code class="language-plaintext highlighter-rouge">df</code> object.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="w">     </span><span class="n">Nombre</span><span class="w">              </span><span class="n">Especie</span><span class="w"> </span><span class="n">Observaciones</span><span class="w"> </span><span class="n">DAP1</span><span class="w"> </span><span class="n">DAP2</span><span class="w"> </span><span class="n">DAP3</span><span class="w"> </span><span class="n">DAP4</span><span class="w"> </span><span class="n">DAP5</span><span class="w"> </span><span class="n">DAP6</span><span class="w"> </span><span class="n">DAP7</span><span class="w"> </span><span class="n">DAP8</span><span class="w"> </span><span class="n">DAP9</span><span class="w"> </span><span class="n">DAP10</span><span class="w"> </span><span class="n">DAP11</span><span class="w">
</span><span class="m">1</span><span class="w">      </span><span class="o">&lt;</span><span class="kc">NA</span><span class="o">&gt;</span><span class="w">                 </span><span class="o">&lt;</span><span class="kc">NA</span><span class="o">&gt;</span><span class="w">          </span><span class="o">&lt;</span><span class="kc">NA</span><span class="o">&gt;</span><span class="w"> </span><span class="m">3.44</span><span class="w">   </span><span class="kc">NA</span><span class="w">   </span><span class="kc">NA</span><span class="w">   </span><span class="kc">NA</span><span class="w">   </span><span class="kc">NA</span><span class="w">   </span><span class="kc">NA</span><span class="w">   </span><span class="kc">NA</span><span class="w">   </span><span class="kc">NA</span><span class="w">   </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">
</span><span class="m">2</span><span class="w">      </span><span class="o">&lt;</span><span class="kc">NA</span><span class="o">&gt;</span><span class="w">                 </span><span class="o">&lt;</span><span class="kc">NA</span><span class="o">&gt;</span><span class="w">          </span><span class="o">&lt;</span><span class="kc">NA</span><span class="o">&gt;</span><span class="w"> </span><span class="m">6.81</span><span class="w">   </span><span class="kc">NA</span><span class="w">   </span><span class="kc">NA</span><span class="w">   </span><span class="kc">NA</span><span class="w">   </span><span class="kc">NA</span><span class="w">   </span><span class="kc">NA</span><span class="w">   </span><span class="kc">NA</span><span class="w">   </span><span class="kc">NA</span><span class="w">   </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">
</span><span class="m">3</span><span class="w">  </span><span class="n">lysiloma</span><span class="w"> </span><span class="n">Lysiloma</span><span class="w"> </span><span class="n">divaricatum</span><span class="w">          </span><span class="o">&lt;</span><span class="kc">NA</span><span class="o">&gt;</span><span class="w"> </span><span class="m">3.12</span><span class="w">   </span><span class="kc">NA</span><span class="w">   </span><span class="kc">NA</span><span class="w">   </span><span class="kc">NA</span><span class="w">   </span><span class="kc">NA</span><span class="w">   </span><span class="kc">NA</span><span class="w">   </span><span class="kc">NA</span><span class="w">   </span><span class="kc">NA</span><span class="w">   </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">
</span><span class="m">4</span><span class="w"> </span><span class="n">leocarpus</span><span class="w">      </span><span class="n">Heliocarpus</span><span class="w"> </span><span class="n">sp.</span><span class="w">          </span><span class="o">&lt;</span><span class="kc">NA</span><span class="o">&gt;</span><span class="w"> </span><span class="m">8.72</span><span class="w">   </span><span class="kc">NA</span><span class="w">   </span><span class="kc">NA</span><span class="w">   </span><span class="kc">NA</span><span class="w">   </span><span class="kc">NA</span><span class="w">   </span><span class="kc">NA</span><span class="w">   </span><span class="kc">NA</span><span class="w">   </span><span class="kc">NA</span><span class="w">   </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">
</span><span class="m">5</span><span class="w">    </span><span class="n">muerto</span><span class="w">                 </span><span class="o">&lt;</span><span class="kc">NA</span><span class="o">&gt;</span><span class="w">          </span><span class="o">&lt;</span><span class="kc">NA</span><span class="o">&gt;</span><span class="w"> </span><span class="m">4.04</span><span class="w">   </span><span class="kc">NA</span><span class="w">   </span><span class="kc">NA</span><span class="w">   </span><span class="kc">NA</span><span class="w">   </span><span class="kc">NA</span><span class="w">   </span><span class="kc">NA</span><span class="w">   </span><span class="kc">NA</span><span class="w">   </span><span class="kc">NA</span><span class="w">   </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">
</span><span class="m">6</span><span class="w"> </span><span class="n">leocarpus</span><span class="w">      </span><span class="n">Heliocarpus</span><span class="w"> </span><span class="n">sp.</span><span class="w">          </span><span class="o">&lt;</span><span class="kc">NA</span><span class="o">&gt;</span><span class="w"> </span><span class="m">3.34</span><span class="w">   </span><span class="kc">NA</span><span class="w">   </span><span class="kc">NA</span><span class="w">   </span><span class="kc">NA</span><span class="w">   </span><span class="kc">NA</span><span class="w">   </span><span class="kc">NA</span><span class="w">   </span><span class="kc">NA</span><span class="w">   </span><span class="kc">NA</span><span class="w">   </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">
  </span><span class="n">DAP12</span><span class="w"> </span><span class="n">DAP13</span><span class="w"> </span><span class="n">DAP14</span><span class="w"> </span><span class="n">DAP15</span><span class="w"> </span><span class="n">DAP16</span><span class="w"> </span><span class="n">DAP17</span><span class="w"> </span><span class="n">DAP18</span><span class="w"> </span><span class="n">DAP19</span><span class="w"> </span><span class="n">DAP20</span><span class="w"> </span><span class="n">DAP21</span><span class="w"> </span><span class="n">DAP22</span><span class="w"> </span><span class="n">DAP23</span><span class="w"> </span><span class="n">DAP24</span><span class="w"> </span><span class="n">Altura</span><span class="w">  </span><span class="n">parcela</span><span class="w">         </span><span class="n">x</span><span class="w">
</span><span class="m">1</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">   </span><span class="m">1.66</span><span class="w"> </span><span class="n">Amacuau1</span><span class="w"> </span><span class="m">19</span><span class="err">°</span><span class="m">53.904</span><span class="w">
</span><span class="m">2</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">   </span><span class="m">4.56</span><span class="w"> </span><span class="n">Amacuau1</span><span class="w"> </span><span class="m">19</span><span class="err">°</span><span class="m">53.904</span><span class="w">
</span><span class="m">3</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">   </span><span class="m">3.65</span><span class="w"> </span><span class="n">Amacuau1</span><span class="w"> </span><span class="m">19</span><span class="err">°</span><span class="m">53.904</span><span class="w">
</span><span class="m">4</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">   </span><span class="m">5.29</span><span class="w"> </span><span class="n">Amacuau1</span><span class="w"> </span><span class="m">19</span><span class="err">°</span><span class="m">53.904</span><span class="w">
</span><span class="m">5</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">   </span><span class="m">2.69</span><span class="w"> </span><span class="n">Amacuau1</span><span class="w"> </span><span class="m">19</span><span class="err">°</span><span class="m">53.904</span><span class="w">
</span><span class="m">6</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">    </span><span class="kc">NA</span><span class="w">   </span><span class="m">3.02</span><span class="w"> </span><span class="n">Amacuau1</span><span class="w"> </span><span class="m">19</span><span class="err">°</span><span class="m">53.904</span><span class="w">
           </span><span class="n">y</span><span class="w"> </span><span class="n">cobertura</span><span class="w"> </span><span class="n">register</span><span class="w"> </span><span class="n">Observaciones.sitio</span><span class="w"> </span><span class="n">id</span><span class="w">   </span><span class="n">DAP1.BA</span><span class="w"> </span><span class="n">DAP2.BA</span><span class="w"> </span><span class="n">DAP3.BA</span><span class="w"> </span><span class="n">DAP4.BA</span><span class="w"> </span><span class="n">DAP5.BA</span><span class="w"> </span><span class="n">DAP6.BA</span><span class="w">
</span><span class="m">1</span><span class="w"> </span><span class="m">104</span><span class="err">°</span><span class="m">06.428</span><span class="w">     </span><span class="m">70-80</span><span class="w">      </span><span class="n">Yan</span><span class="w">                </span><span class="o">&lt;</span><span class="kc">NA</span><span class="o">&gt;</span><span class="w">  </span><span class="m">1</span><span class="w">  </span><span class="m">9.294088</span><span class="w">      </span><span class="kc">NA</span><span class="w">      </span><span class="kc">NA</span><span class="w">      </span><span class="kc">NA</span><span class="w">      </span><span class="kc">NA</span><span class="w">      </span><span class="kc">NA</span><span class="w">
</span><span class="m">2</span><span class="w"> </span><span class="m">104</span><span class="err">°</span><span class="m">06.428</span><span class="w">     </span><span class="m">70-80</span><span class="w">      </span><span class="n">Yan</span><span class="w">                </span><span class="o">&lt;</span><span class="kc">NA</span><span class="o">&gt;</span><span class="w">  </span><span class="m">2</span><span class="w"> </span><span class="m">36.423704</span><span class="w">      </span><span class="kc">NA</span><span class="w">      </span><span class="kc">NA</span><span class="w">      </span><span class="kc">NA</span><span class="w">      </span><span class="kc">NA</span><span class="w">      </span><span class="kc">NA</span><span class="w">
</span><span class="m">3</span><span class="w"> </span><span class="m">104</span><span class="err">°</span><span class="m">06.428</span><span class="w">     </span><span class="m">70-80</span><span class="w">      </span><span class="n">Yan</span><span class="w">                </span><span class="o">&lt;</span><span class="kc">NA</span><span class="o">&gt;</span><span class="w">  </span><span class="m">3</span><span class="w">  </span><span class="m">7.645380</span><span class="w">      </span><span class="kc">NA</span><span class="w">      </span><span class="kc">NA</span><span class="w">      </span><span class="kc">NA</span><span class="w">      </span><span class="kc">NA</span><span class="w">      </span><span class="kc">NA</span><span class="w">
</span><span class="m">4</span><span class="w"> </span><span class="m">104</span><span class="err">°</span><span class="m">06.428</span><span class="w">     </span><span class="m">70-80</span><span class="w">      </span><span class="n">Yan</span><span class="w">                </span><span class="o">&lt;</span><span class="kc">NA</span><span class="o">&gt;</span><span class="w">  </span><span class="m">4</span><span class="w"> </span><span class="m">59.720420</span><span class="w">      </span><span class="kc">NA</span><span class="w">      </span><span class="kc">NA</span><span class="w">      </span><span class="kc">NA</span><span class="w">      </span><span class="kc">NA</span><span class="w">      </span><span class="kc">NA</span><span class="w">
</span><span class="m">5</span><span class="w"> </span><span class="m">104</span><span class="err">°</span><span class="m">06.428</span><span class="w">     </span><span class="m">70-80</span><span class="w">      </span><span class="n">Yan</span><span class="w">                </span><span class="o">&lt;</span><span class="kc">NA</span><span class="o">&gt;</span><span class="w">  </span><span class="m">5</span><span class="w"> </span><span class="m">12.818955</span><span class="w">      </span><span class="kc">NA</span><span class="w">      </span><span class="kc">NA</span><span class="w">      </span><span class="kc">NA</span><span class="w">      </span><span class="kc">NA</span><span class="w">      </span><span class="kc">NA</span><span class="w">
</span><span class="m">6</span><span class="w"> </span><span class="m">104</span><span class="err">°</span><span class="m">06.428</span><span class="w">     </span><span class="m">70-80</span><span class="w">      </span><span class="n">Yan</span><span class="w">                </span><span class="o">&lt;</span><span class="kc">NA</span><span class="o">&gt;</span><span class="w">  </span><span class="m">6</span><span class="w">  </span><span class="m">8.761588</span><span class="w">      </span><span class="kc">NA</span><span class="w">      </span><span class="kc">NA</span><span class="w">      </span><span class="kc">NA</span><span class="w">      </span><span class="kc">NA</span><span class="w">      </span><span class="kc">NA</span><span class="w">
  </span><span class="n">DAP7.BA</span><span class="w"> </span><span class="n">DAP8.BA</span><span class="w"> </span><span class="n">DAP9.BA</span><span class="w"> </span><span class="n">DAP10.BA</span><span class="w"> </span><span class="n">DAP11.BA</span><span class="w"> </span><span class="n">DAP12.BA</span><span class="w"> </span><span class="n">DAP13.BA</span><span class="w"> </span><span class="n">DAP14.BA</span><span class="w"> </span><span class="n">DAP15.BA</span><span class="w"> </span><span class="n">DAP16.BA</span><span class="w"> </span><span class="n">DAP17.BA</span><span class="w"> </span><span class="n">DAP18.BA</span><span class="w">
</span><span class="m">1</span><span class="w">      </span><span class="kc">NA</span><span class="w">      </span><span class="kc">NA</span><span class="w">      </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">
</span><span class="m">2</span><span class="w">      </span><span class="kc">NA</span><span class="w">      </span><span class="kc">NA</span><span class="w">      </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">
</span><span class="m">3</span><span class="w">      </span><span class="kc">NA</span><span class="w">      </span><span class="kc">NA</span><span class="w">      </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">
</span><span class="m">4</span><span class="w">      </span><span class="kc">NA</span><span class="w">      </span><span class="kc">NA</span><span class="w">      </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">
</span><span class="m">5</span><span class="w">      </span><span class="kc">NA</span><span class="w">      </span><span class="kc">NA</span><span class="w">      </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">
</span><span class="m">6</span><span class="w">      </span><span class="kc">NA</span><span class="w">      </span><span class="kc">NA</span><span class="w">      </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">
  </span><span class="n">DAP19.BA</span><span class="w"> </span><span class="n">DAP20.BA</span><span class="w"> </span><span class="n">DAP21.BA</span><span class="w"> </span><span class="n">DAP22.BA</span><span class="w"> </span><span class="n">DAP23.BA</span><span class="w"> </span><span class="n">DAP24.BA</span><span class="w">
</span><span class="m">1</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">
</span><span class="m">2</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">
</span><span class="m">3</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">
</span><span class="m">4</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">
</span><span class="m">5</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">
</span><span class="m">6</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span><span class="w">       </span><span class="kc">NA</span></code></pre></figure>

<p>and like the following for the <code class="language-plaintext highlighter-rouge">coords</code> file.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="w">      </span><span class="n">name</span><span class="w"> </span><span class="n">elevation</span><span class="w">       </span><span class="n">date</span><span class="w">         </span><span class="n">x</span><span class="w">        </span><span class="n">y</span><span class="w">     </span><span class="n">xutm</span><span class="w">    </span><span class="n">ytum</span><span class="w">
</span><span class="m">1</span><span class="w">   </span><span class="n">LIMON1</span><span class="w"> </span><span class="m">1118.1133</span><span class="w"> </span><span class="m">2022</span><span class="o">/</span><span class="m">05</span><span class="o">/</span><span class="m">12</span><span class="w"> </span><span class="m">-104.1652</span><span class="w"> </span><span class="m">19.83815</span><span class="w"> </span><span class="m">587412.5</span><span class="w"> </span><span class="m">2193788</span><span class="w">
</span><span class="m">2</span><span class="w"> </span><span class="n">AMACUAU1</span><span class="w">  </span><span class="m">998.5761</span><span class="w"> </span><span class="m">2022</span><span class="o">/</span><span class="m">05</span><span class="o">/</span><span class="m">13</span><span class="w"> </span><span class="m">-104.1071</span><span class="w"> </span><span class="m">19.89840</span><span class="w"> </span><span class="m">593460.8</span><span class="w"> </span><span class="m">2200486</span></code></pre></figure>

<h1 id="fix-taxonomy-and-get-wood-density-for-agb-calculation">Fix taxonomy and get wood density for AGB calculation</h1>

<p>The first step is to get the corrected names of the species registered in the field. This information will be used to get the wood density by species, genus or family, depending on what info is available in the global woodensity database. Then this wood density is going to be used to calculate AGB as</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># Separate genus and species</span><span class="w">
</span><span class="n">df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">genus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">str_extract</span><span class="p">(</span><span class="n">Especie</span><span class="p">,</span><span class="w"> </span><span class="s2">"[A-z]+(?= )"</span><span class="p">),</span><span class="w">
         </span><span class="n">species</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">str_extract</span><span class="p">(</span><span class="n">Especie</span><span class="p">,</span><span class="w"> </span><span class="s2">"(?&lt;= )[A-z]+(?=)"</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">across</span><span class="p">(</span><span class="n">species</span><span class="p">,</span><span class="w"> </span><span class="o">~</span><span class="n">gsub</span><span class="p">(</span><span class="s2">"sp|sp."</span><span class="p">,</span><span class="s2">"NA"</span><span class="p">,</span><span class="n">.x</span><span class="p">)))</span><span class="w">

</span><span class="c1"># Correct taxo names</span><span class="w">
</span><span class="n">taxo</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">correctTaxo</span><span class="p">(</span><span class="n">genus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df</span><span class="o">$</span><span class="n">genus</span><span class="p">,</span><span class="w"> 
                    </span><span class="n">species</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df</span><span class="o">$</span><span class="n">species</span><span class="p">,</span><span class="w"> 
                    </span><span class="n">useCache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">F</span><span class="p">,</span><span class="w"> 
                    </span><span class="n">verbose</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w">

</span><span class="c1"># Add as new columns</span><span class="w">
</span><span class="n">df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">genuscorr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">taxo</span><span class="o">$</span><span class="n">genusCorrected</span><span class="p">,</span><span class="w">
         </span><span class="n">speciescorr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">taxo</span><span class="o">$</span><span class="n">speciesCorrected</span><span class="p">)</span><span class="w">

</span><span class="c1"># Get family according to APG 3</span><span class="w">
</span><span class="n">APG</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">getTaxonomy</span><span class="p">(</span><span class="n">df</span><span class="o">$</span><span class="n">genuscorr</span><span class="p">,</span><span class="w"> </span><span class="n">findOrder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">

</span><span class="c1"># Add to original df</span><span class="w">
</span><span class="n">df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">family</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">APG</span><span class="o">$</span><span class="n">family</span><span class="p">)</span><span class="w">

</span><span class="c1"># Get wood density</span><span class="w">
</span><span class="n">dataWD</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">getWoodDensity</span><span class="p">(</span><span class="w">
  </span><span class="n">genus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df</span><span class="o">$</span><span class="n">genuscorr</span><span class="p">,</span><span class="w">
  </span><span class="n">species</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df</span><span class="o">$</span><span class="n">speciescorr</span><span class="p">,</span><span class="w">
  </span><span class="n">family</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df</span><span class="o">$</span><span class="n">family</span><span class="p">,</span><span class="w">
  </span><span class="n">region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"World"</span><span class="p">,</span><span class="w">
  </span><span class="n">stand</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df</span><span class="o">$</span><span class="n">parcela</span><span class="w">
</span><span class="p">)</span><span class="w">

</span><span class="c1"># add as columns to df</span><span class="w">
</span><span class="n">df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">meanwood</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dataWD</span><span class="o">$</span><span class="n">meanWD</span><span class="p">,</span><span class="w">
         </span><span class="n">sdwood</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dataWD</span><span class="o">$</span><span class="n">sdWD</span><span class="p">,</span><span class="w">
         </span><span class="n">levelwood</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dataWD</span><span class="o">$</span><span class="n">levelWD</span><span class="p">,</span><span class="w">
         </span><span class="n">nInd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dataWD</span><span class="o">$</span><span class="n">nInd</span><span class="p">)</span><span class="w">

</span><span class="c1"># Compute AGB for all DAP</span><span class="w">
</span><span class="n">df_agb</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">across</span><span class="p">(</span><span class="n">matches</span><span class="p">(</span><span class="s2">"DAP[0-9]+$"</span><span class="p">),</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">computeAGB</span><span class="p">(</span><span class="n">D</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">.x</span><span class="p">,</span><span class="w">
                                                    </span><span class="n">WD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">meanwood</span><span class="p">,</span><span class="w">
                                                    </span><span class="n">H</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Altura</span><span class="p">)))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">select</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">matches</span><span class="p">(</span><span class="s2">"DAP[0-9]+$"</span><span class="p">))</span><span class="w">

</span><span class="n">colnames</span><span class="p">(</span><span class="n">df_agb</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"id"</span><span class="p">,</span><span class="w"> </span><span class="n">paste0</span><span class="p">((</span><span class="s2">"AGB"</span><span class="p">),</span><span class="w"> </span><span class="n">seq</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">24</span><span class="p">)))</span><span class="w">

</span><span class="c1"># Join AGB by id</span><span class="w">
</span><span class="n">df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">left_join</span><span class="p">(</span><span class="n">df_agb</span><span class="p">,</span><span class="w"> </span><span class="s2">"id"</span><span class="p">)</span></code></pre></figure>

<p>After these steps we now got the individual AGB for each stem and individual, as new columns of the original df. So the next step is going to calculate these same metrics for each individual (e.g., individual AGB sum of all of its stems). Watch that you might need to change some parameters of the <code class="language-plaintext highlighter-rouge">subplot_size</code> definition according to your own sampling design.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># Max DAP, plot extent</span><span class="w">
</span><span class="n">subplot_size</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">df</span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">select</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">matches</span><span class="p">(</span><span class="s2">"DAP[0-9]+$"</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">pivot_longer</span><span class="p">(</span><span class="n">cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">id</span><span class="p">,</span><span class="w"> 
               </span><span class="n">names_to</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"AGB"</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">drop_na</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">group_by</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">summarise</span><span class="p">(</span><span class="n">DAP_max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="n">value</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">subplot_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">case_when</span><span class="p">(</span><span class="n">DAP_max</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="m">500</span><span class="p">,</span><span class="w">
                                  </span><span class="n">DAP_max</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="m">2.5</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">DAP_max</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="m">29</span><span class="p">,</span><span class="w">
                                  </span><span class="n">DAP_max</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">2.5</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="m">0</span><span class="p">))</span><span class="w">

</span><span class="c1"># AGB sum</span><span class="w">
</span><span class="n">AGB</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">df</span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">select</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">starts_with</span><span class="p">(</span><span class="s2">"AGB"</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">pivot_longer</span><span class="p">(</span><span class="n">cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">id</span><span class="p">,</span><span class="w"> 
               </span><span class="n">names_to</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"AGB"</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">drop_na</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">group_by</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">summarise</span><span class="p">(</span><span class="n">AGB_sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">value</span><span class="p">))</span><span class="w">

</span><span class="c1"># number of stems</span><span class="w">
</span><span class="n">Stems</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">df</span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">select</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">starts_with</span><span class="p">(</span><span class="s2">"AGB"</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">pivot_longer</span><span class="p">(</span><span class="n">cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">id</span><span class="p">,</span><span class="w"> 
               </span><span class="n">names_to</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"AGB"</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">drop_na</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">group_by</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">summarise</span><span class="p">(</span><span class="n">Stem_sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">())</span><span class="w">

</span><span class="c1"># Basal area</span><span class="w">
</span><span class="n">BA</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">df</span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">select</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">ends_with</span><span class="p">(</span><span class="s2">"BA"</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">pivot_longer</span><span class="p">(</span><span class="n">cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">id</span><span class="p">,</span><span class="w"> 
               </span><span class="n">names_to</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"BA"</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">drop_na</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">group_by</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">summarise</span><span class="p">(</span><span class="n">BA_sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">value</span><span class="p">))</span><span class="w">

</span><span class="c1"># Join previous calculation to original df</span><span class="w">
</span><span class="n">df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">left_join</span><span class="p">(</span><span class="n">AGB</span><span class="p">,</span><span class="w"> </span><span class="s2">"id"</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">left_join</span><span class="p">(</span><span class="n">BA</span><span class="p">,</span><span class="w"> </span><span class="s2">"id"</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">left_join</span><span class="p">(</span><span class="n">Stems</span><span class="p">,</span><span class="w"> </span><span class="s2">"id"</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">left_join</span><span class="p">(</span><span class="n">subplot_size</span><span class="p">,</span><span class="w"> </span><span class="s2">"id"</span><span class="p">)</span><span class="w">

</span><span class="c1"># Select variables of interest</span><span class="w">
</span><span class="n">df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">select</span><span class="p">(</span><span class="n">parcela</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">cobertura</span><span class="p">,</span><span class="w"> </span><span class="n">Observaciones.sitio</span><span class="p">,</span><span class="w"> 
         </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">subplot_size</span><span class="p">,</span><span class="w"> </span><span class="n">AGB_sum</span><span class="p">,</span><span class="w"> </span><span class="n">BA_sum</span><span class="p">,</span><span class="w"> </span><span class="n">Stem_sum</span><span class="p">,</span><span class="w"> </span><span class="n">Altura</span><span class="p">,</span><span class="w"> 
         </span><span class="n">genuscorr</span><span class="p">,</span><span class="w"> </span><span class="n">speciescorr</span><span class="p">,</span><span class="w"> </span><span class="n">meanwood</span><span class="p">,</span><span class="w"> </span><span class="n">levelwood</span><span class="p">,</span><span class="w">
         </span><span class="n">register</span><span class="p">)</span><span class="w"> </span></code></pre></figure>

<p>Now that we have the individual measures we need to calculate the per plot variables: AGBplot, BAplot, Dplot, Stemplot, Hmplot, H10plot. Since some of these measures are sums, extrapolated to 1 ha sums, means, etc, each one is summarised using the most common function to calculate it (e.g., AGB sum, height mean). Finally, we assume that the best registered coordinates are located in the  <code class="language-plaintext highlighter-rouge">coords</code> file; thus, these coordinates are pasted on to the final result.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># -------------------Per plot variables------------------------------</span><span class="w">
</span><span class="c1"># Summarise variables that need to be extrapolated</span><span class="w">
</span><span class="n">vars1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">group_by</span><span class="p">(</span><span class="n">parcela</span><span class="p">,</span><span class="w"> </span><span class="n">subplot_size</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="c1"># Sums by subplot_size</span><span class="w">
  </span><span class="n">summarise</span><span class="p">(</span><span class="n">AGBsubplot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">AGB_sum</span><span class="p">),</span><span class="w">
            </span><span class="n">BAsubplot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">BA_sum</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">10000</span><span class="p">,</span><span class="w">
            </span><span class="n">Dsubplot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">(),</span><span class="w">
            </span><span class="n">Stemsubplot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">Stem_sum</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="c1"># Extrapolate to 1 ha according to the subplot size</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">across</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="n">AGBsubplot</span><span class="p">,</span><span class="w"> </span><span class="n">BAsubplot</span><span class="p">,</span><span class="w"> </span><span class="n">Dsubplot</span><span class="p">,</span><span class="w"> </span><span class="n">Stemsubplot</span><span class="p">),</span><span class="w"> </span><span class="o">~</span><span class="n">.x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">10000</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">subplot_size</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">ungroup</span><span class="p">()</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">group_by</span><span class="p">(</span><span class="n">parcela</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="c1"># Sum both subplot estimates</span><span class="w">
  </span><span class="n">summarise</span><span class="p">(</span><span class="n">AGBplot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">AGBsubplot</span><span class="p">),</span><span class="w">
            </span><span class="n">BAplot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">BAsubplot</span><span class="p">),</span><span class="w">
            </span><span class="n">Dplot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">Dsubplot</span><span class="p">),</span><span class="w">
            </span><span class="n">Stemplot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">Stemsubplot</span><span class="p">))</span><span class="w">

</span><span class="c1"># Calculate top 10 mean height</span><span class="w">
</span><span class="n">vars2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">group_by</span><span class="p">(</span><span class="n">parcela</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">slice_max</span><span class="p">(</span><span class="n">Altura</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">summarise</span><span class="p">(</span><span class="n">H10plot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">Altura</span><span class="p">))</span><span class="w">

</span><span class="c1"># Cover</span><span class="w">
</span><span class="n">vars3</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">select</span><span class="p">(</span><span class="n">parcela</span><span class="p">,</span><span class="w"> </span><span class="n">cobertura</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">separate</span><span class="p">(</span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cobertura</span><span class="p">,</span><span class="w"> 
           </span><span class="n">sep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"-"</span><span class="p">,</span><span class="w">
           </span><span class="n">into</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"cob1"</span><span class="p">,</span><span class="w"> </span><span class="s2">"cob2"</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">across</span><span class="p">(</span><span class="n">starts_with</span><span class="p">(</span><span class="s2">"cob"</span><span class="p">),</span><span class="w"> </span><span class="o">~</span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">.x</span><span class="p">)))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">group_by</span><span class="p">(</span><span class="n">parcela</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">summarise</span><span class="p">(</span><span class="n">cob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="n">cob1</span><span class="p">,</span><span class="w"> </span><span class="n">cob2</span><span class="p">),</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">))</span><span class="w">

</span><span class="c1"># Mean height</span><span class="w">
</span><span class="n">vars4</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">group_by</span><span class="p">(</span><span class="n">parcela</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">summarise</span><span class="p">(</span><span class="n">Hmplot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">Altura</span><span class="p">))</span><span class="w">

</span><span class="c1"># Join all calculations</span><span class="w">
</span><span class="n">resul</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">vars1</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">left_join</span><span class="p">(</span><span class="n">vars2</span><span class="p">,</span><span class="w"> </span><span class="s2">"parcela"</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">left_join</span><span class="p">(</span><span class="n">vars3</span><span class="p">,</span><span class="w"> </span><span class="s2">"parcela"</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">left_join</span><span class="p">(</span><span class="n">df</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
              </span><span class="n">select</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">parcela</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
              </span><span class="n">distinct</span><span class="p">(</span><span class="n">parcela</span><span class="p">,</span><span class="w"> </span><span class="n">.keep_all</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">),</span><span class="w">
            </span><span class="s2">"parcela"</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">left_join</span><span class="p">(</span><span class="n">vars4</span><span class="p">,</span><span class="w"> </span><span class="s2">"parcela"</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">select</span><span class="p">(</span><span class="n">parcela</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">cob</span><span class="p">,</span><span class="w"> </span><span class="n">AGBplot</span><span class="p">,</span><span class="w"> </span><span class="n">BAplot</span><span class="p">,</span><span class="w"> </span><span class="n">Dplot</span><span class="p">,</span><span class="w"> </span><span class="n">Stemplot</span><span class="p">,</span><span class="w"> </span><span class="n">Hmplot</span><span class="p">,</span><span class="w"> </span><span class="n">H10plot</span><span class="p">)</span><span class="w">

</span><span class="c1"># Rename columns</span><span class="w">
</span><span class="n">colnames</span><span class="p">(</span><span class="n">resul</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"Plot"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Lat"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Long"</span><span class="p">,</span><span class="w">
                     </span><span class="s2">"Cob(%)"</span><span class="p">,</span><span class="w"> </span><span class="s2">"AGB(Mgha-1)"</span><span class="p">,</span><span class="w"> </span><span class="s2">"BA(m2ha-1)"</span><span class="p">,</span><span class="w">
                     </span><span class="s2">"Dplot(indha-1)"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Stemplot(stemha-1)"</span><span class="p">,</span><span class="w">
                     </span><span class="s2">"Hmean(m)"</span><span class="p">,</span><span class="w"> </span><span class="s2">"H10mean(m)"</span><span class="p">)</span><span class="w">

</span><span class="n">resul</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">resul</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">select</span><span class="p">(</span><span class="o">-</span><span class="nf">c</span><span class="p">(</span><span class="n">Lat</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="p">))</span><span class="w">

</span><span class="n">coords</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">coords</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">rename</span><span class="p">(</span><span class="s2">"yutm"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"ytum"</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">select</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">elevation</span><span class="p">,</span><span class="w"> </span><span class="n">date</span><span class="p">,</span><span class="w"> </span><span class="n">xutm</span><span class="p">,</span><span class="w"> </span><span class="n">yutm</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">across</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="o">~</span><span class="n">str_to_title</span><span class="p">(</span><span class="n">.x</span><span class="p">)))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">rename</span><span class="p">(</span><span class="s2">"Plot"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"name"</span><span class="p">)</span><span class="w">

</span><span class="n">resul</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">resul</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">left_join</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span><span class="w"> </span><span class="s2">"Plot"</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">select</span><span class="p">(</span><span class="n">Plot</span><span class="p">,</span><span class="w"> </span><span class="n">xutm</span><span class="p">,</span><span class="w"> </span><span class="n">yutm</span><span class="p">,</span><span class="w"> </span><span class="n">everything</span><span class="p">())</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">year</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2022</span><span class="p">)</span></code></pre></figure>

<p>Results look like the following.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># A tibble: 2 × 13</span><span class="w">
  </span><span class="n">Plot</span><span class="w">     </span><span class="n">xutm</span><span class="w">   </span><span class="n">yutm</span><span class="w"> </span><span class="n">`Cob(%)`</span><span class="w"> </span><span class="n">`AGB(Mgha-1)`</span><span class="w"> </span><span class="n">`BA(m2ha-1)`</span><span class="w"> </span><span class="n">`Dplot(indha-1)`</span><span class="w"> </span><span class="n">`Stemplot(stemha-1)`</span><span class="w"> </span><span class="n">`Hmean(m)`</span><span class="w">
  </span><span class="o">&lt;</span><span class="n">chr</span><span class="o">&gt;</span><span class="w">   </span><span class="o">&lt;</span><span class="n">dbl</span><span class="o">&gt;</span><span class="w">  </span><span class="o">&lt;</span><span class="n">dbl</span><span class="o">&gt;</span><span class="w">    </span><span class="o">&lt;</span><span class="n">dbl</span><span class="o">&gt;</span><span class="w">         </span><span class="o">&lt;</span><span class="n">dbl</span><span class="o">&gt;</span><span class="w">        </span><span class="o">&lt;</span><span class="n">dbl</span><span class="o">&gt;</span><span class="w">            </span><span class="o">&lt;</span><span class="n">dbl</span><span class="o">&gt;</span><span class="w">                </span><span class="o">&lt;</span><span class="n">dbl</span><span class="o">&gt;</span><span class="w">      </span><span class="o">&lt;</span><span class="n">dbl</span><span class="o">&gt;</span><span class="w">
</span><span class="m">1</span><span class="w"> </span><span class="n">Amacu</span><span class="err">…</span><span class="w"> </span><span class="m">5.93e5</span><span class="w"> </span><span class="m">2.20e6</span><span class="w">       </span><span class="m">75</span><span class="w">          </span><span class="m">37.6</span><span class="w">         </span><span class="m">18.2</span><span class="w">            </span><span class="m">2919</span><span class="n">.</span><span class="w">                </span><span class="m">5159</span><span class="n">.</span><span class="w">       </span><span class="m">4.46</span><span class="w">
</span><span class="m">2</span><span class="w"> </span><span class="n">Limon1</span><span class="w"> </span><span class="m">5.87e5</span><span class="w"> </span><span class="m">2.19e6</span><span class="w">       </span><span class="m">75</span><span class="w">          </span><span class="m">52.8</span><span class="w">         </span><span class="m">29.4</span><span class="w">            </span><span class="m">2130</span><span class="n">.</span><span class="w">                </span><span class="m">4410</span><span class="n">.</span><span class="w">       </span><span class="m">3.77</span><span class="w">
</span><span class="c1"># ℹ 4 more variables: `H10mean(m)` &lt;dbl&gt;, elevation &lt;dbl&gt;, date &lt;chr&gt;, year &lt;dbl&gt;</span></code></pre></figure>]]></content><author><name>Jonathan V. Solórzano</name></author><category term="blog" /><category term="post" /><category term="r" /><category term="BiOMASS" /><category term="AGB" /><category term="community attributes" /><category term="plot-level calculations" /><summary type="html"><![CDATA[AGB forest sampling calculations]]></summary></entry><entry><title type="html">Rasters and vectors with terra</title><link href="http://localhost:4000/blog/rasters-and-vectors-with-terra/" rel="alternate" type="text/html" title="Rasters and vectors with terra" /><published>2023-07-14T10:35:00-06:00</published><updated>2023-07-14T10:35:00-06:00</updated><id>http://localhost:4000/blog/rasters-and-vectors-with-terra</id><content type="html" xml:base="http://localhost:4000/blog/rasters-and-vectors-with-terra/"><![CDATA[<h1 id="rasters-and-vectors-with-terra">Rasters and vectors with terra</h1>

<p>This post shows a simple example of how to work with rasters and vectors using the terra package. Terra replaces the older raster package, since terra is usually faster to use.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="n">tibble</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">terra</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span></code></pre></figure>

<p>Then create some objects to work with and plot them.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">im1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rast</span><span class="p">(</span><span class="n">matrix</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="m">9</span><span class="p">,</span><span class="w"> </span><span class="n">nrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="p">),</span><span class="w">
            </span><span class="n">crs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"EPSG:4326"</span><span class="p">,</span><span class="w">
            </span><span class="n">extent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">-103</span><span class="p">,</span><span class="m">-100</span><span class="p">,</span><span class="m">19</span><span class="p">,</span><span class="m">22</span><span class="p">))</span><span class="w">

</span><span class="n">pts1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">vect</span><span class="p">(</span><span class="n">data.frame</span><span class="p">(</span><span class="n">lon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">-102.5</span><span class="p">,</span><span class="w"> </span><span class="m">-102.5</span><span class="p">,</span><span class="w"> </span><span class="m">-100.5</span><span class="p">,</span><span class="w"> </span><span class="m">-100.5</span><span class="p">),</span><span class="w">
                        </span><span class="n">lat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">19.5</span><span class="p">,</span><span class="w"> </span><span class="m">21.5</span><span class="p">,</span><span class="w"> </span><span class="m">21.5</span><span class="p">,</span><span class="w"> </span><span class="m">19.5</span><span class="p">)),</span><span class="w">
             </span><span class="n">geom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"lon"</span><span class="p">,</span><span class="w"> </span><span class="s2">"lat"</span><span class="p">),</span><span class="w"> 
             </span><span class="n">crs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"EPSG:4326"</span><span class="p">)</span><span class="w">

</span><span class="n">poly1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">vect</span><span class="p">(</span><span class="s2">"POLYGON ((-102.5 19.5, -102.5 21.5, -100.5 21.5, -100.5 19.5, -102.5 19.5))"</span><span class="p">,</span><span class="w">
             </span><span class="n">crs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"EPSG:4326"</span><span class="p">)</span><span class="w">

</span><span class="n">plot</span><span class="p">(</span><span class="n">im1</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">pts1</span><span class="p">,</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">poly1</span><span class="p">,</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">)</span></code></pre></figure>

<p style="text-align: center; font-size:0.75em;"><a href="http://localhost:4000/assets/images/terra1.png"><img src="http://localhost:4000/assets/images/terra1.png" alt="styled-image" class="align-center" style="width: 30%;" /></a> Data.</p>

<h1 id="vector-operations">Vector operations</h1>

<h2 id="buffer">Buffer</h2>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">poly2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">buffer</span><span class="p">(</span><span class="n">poly1</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10000</span><span class="p">,</span><span class="w"> </span><span class="n">capstyle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"square"</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">poly2</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">poly1</span><span class="p">,</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">)</span></code></pre></figure>

<p style="text-align: center; font-size:0.75em;"><a href="http://localhost:4000/assets/images/terra2.png"><img src="http://localhost:4000/assets/images/terra2.png" alt="styled-image" class="align-center" style="width: 30%;" /></a> Buffer.</p>

<h2 id="intersection">Intersection</h2>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">poly3</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">intersect</span><span class="p">(</span><span class="n">poly2</span><span class="p">,</span><span class="w"> </span><span class="n">poly1</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">poly3</span><span class="p">[[</span><span class="m">1</span><span class="p">]])</span></code></pre></figure>

<p style="text-align: center; font-size:0.75em;"><a href="http://localhost:4000/assets/images/terra3.png"><img src="http://localhost:4000/assets/images/terra3.png" alt="styled-image" class="align-center" style="width: 30%;" /></a> Intersection.</p>

<h1 id="raster-operations">Raster operations</h1>

<h2 id="mask-values">Mask values</h2>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">im2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">im1</span><span class="w">
</span><span class="n">im2</span><span class="p">[</span><span class="n">im2</span><span class="o">&gt;=</span><span class="m">5</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kc">NA</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">im2</span><span class="p">)</span></code></pre></figure>

<p style="text-align: center; font-size:0.75em;"><a href="http://localhost:4000/assets/images/terra4.png"><img src="http://localhost:4000/assets/images/terra4.png" alt="styled-image" class="align-center" style="width: 30%;" /></a> Masked raster.</p>

<h2 id="operations-over-all-cells">Operations over all cells</h2>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># Stack same image</span><span class="w">
</span><span class="n">im3</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span><span class="w"> </span><span class="n">im1</span><span class="p">)</span><span class="w">

</span><span class="n">im4</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">app</span><span class="p">(</span><span class="n">im3</span><span class="p">,</span><span class="w"> </span><span class="n">fun</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"sum"</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">im4</span><span class="p">)</span></code></pre></figure>

<p style="text-align: center; font-size:0.75em;"><a href="http://localhost:4000/assets/images/terra5.png"><img src="http://localhost:4000/assets/images/terra5.png" alt="styled-image" class="align-center" style="width: 30%;" /></a> Sum of both bands.</p>

<h2 id="global-operations">Global operations</h2>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">global</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span><span class="w"> </span><span class="n">fun</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"mean"</span><span class="p">)</span><span class="w">
      </span><span class="n">mean</span><span class="w">
</span><span class="n">lyr.1</span><span class="w">    </span><span class="m">5</span></code></pre></figure>

<h2 id="focal-operations">Focal operations</h2>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">im5</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">focal</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="n">fun</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"max"</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">im5</span><span class="p">)</span></code></pre></figure>

<p style="text-align: center; font-size:0.75em;"><a href="http://localhost:4000/assets/images/terra6.png"><img src="http://localhost:4000/assets/images/terra6.png" alt="styled-image" class="align-center" style="width: 30%;" /></a> Focal max.</p>

<h1 id="raster-vector-operations">Raster vector operations</h1>

<h2 id="crop">Crop</h2>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">im1_c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">crop</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span><span class="w"> </span><span class="n">poly1</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">im1_c</span><span class="p">)</span></code></pre></figure>

<p style="text-align: center; font-size:0.75em;"><a href="http://localhost:4000/assets/images/terra7.png"><img src="http://localhost:4000/assets/images/terra7.png" alt="styled-image" class="align-center" style="width: 30%;" /></a> Cropped images.</p>

<h2 id="mask">Mask</h2>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">im2_c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">mask</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span><span class="w"> </span><span class="n">poly1</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">im2_c</span><span class="p">)</span></code></pre></figure>

<p style="text-align: center; font-size:0.75em;"><a href="http://localhost:4000/assets/images/terra8.png"><img src="http://localhost:4000/assets/images/terra8.png" alt="styled-image" class="align-center" style="width: 30%;" /></a> Masked image (seems nothing happened due to overlap between raster and polygon).</p>

<h2 id="extract-values">Extract values</h2>

<h3 id="manual-colors">Manual colors</h3>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">expts</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">extract</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span><span class="w"> </span><span class="n">pts1</span><span class="p">)</span><span class="w">

</span><span class="c1"># Get x and y coordinates and value</span><span class="w">
</span><span class="n">geom</span><span class="p">(</span><span class="n">pts1</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">as_tibble</span><span class="p">()</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">select</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">expts</span><span class="o">|&gt;</span><span class="n">pull</span><span class="p">(</span><span class="n">lyr.1</span><span class="p">))</span><span class="w">

</span><span class="c1"># A tibble: 4 × 3</span><span class="w">
      </span><span class="n">x</span><span class="w">     </span><span class="n">y</span><span class="w"> </span><span class="n">value</span><span class="w">
  </span><span class="o">&lt;</span><span class="n">dbl</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&lt;</span><span class="n">dbl</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&lt;</span><span class="n">int</span><span class="o">&gt;</span><span class="w">
</span><span class="m">1</span><span class="w"> </span><span class="m">-102</span><span class="n">.</span><span class="w">  </span><span class="m">19.5</span><span class="w">     </span><span class="m">3</span><span class="w">
</span><span class="m">2</span><span class="w"> </span><span class="m">-102</span><span class="n">.</span><span class="w">  </span><span class="m">21.5</span><span class="w">     </span><span class="m">1</span><span class="w">
</span><span class="m">3</span><span class="w"> </span><span class="m">-100</span><span class="n">.</span><span class="w">  </span><span class="m">21.5</span><span class="w">     </span><span class="m">7</span><span class="w">
</span><span class="m">4</span><span class="w"> </span><span class="m">-100</span><span class="n">.</span><span class="w">  </span><span class="m">19.5</span><span class="w">     </span><span class="m">9</span></code></pre></figure>]]></content><author><name>Jonathan V. Solórzano</name></author><category term="blog" /><category term="post" /><category term="r" /><category term="ggplot2" /><category term="plot" /><category term="grammar of graphics" /><category term="figures" /><summary type="html"><![CDATA[Rasters and vectors with terra]]></summary></entry><entry><title type="html">Working with LiDAR data in R</title><link href="http://localhost:4000/blog/working-with-lidar/" rel="alternate" type="text/html" title="Working with LiDAR data in R" /><published>2023-06-22T08:10:30-06:00</published><updated>2023-06-22T08:10:30-06:00</updated><id>http://localhost:4000/blog/working-with-lidar</id><content type="html" xml:base="http://localhost:4000/blog/working-with-lidar/"><![CDATA[<h1 id="working-with-lidar-data-in-r">Working with LiDAR data in R</h1>

<p>For this example we are going to use the <code class="language-plaintext highlighter-rouge">lidR</code> package. Additionally, we are going to load <code class="language-plaintext highlighter-rouge">terra</code> <code class="language-plaintext highlighter-rouge">sf</code> and <code class="language-plaintext highlighter-rouge">dplyr</code>. In this example, we will work with lascatalogs, which enables working with several las files at once.</p>

<p>The first thing is to load the LiDAR data as a catalog and load a shapefile with the areas of interest (that can correspond to in-field measurements). Reading data as a catalog enables refering to the original files without loading all of them into memory.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="n">lidR</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">terra</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">sf</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span><span class="w">

</span><span class="c1"># Load files</span><span class="w">
</span><span class="n">archivos</span><span class="o">&lt;-</span><span class="n">list.files</span><span class="p">(</span><span class="s2">"."</span><span class="p">,</span><span class="w">
    </span><span class="n">pattern</span><span class="o">=</span><span class="s2">"*.las"</span><span class="p">,</span><span class="w">
    </span><span class="n">full.names</span><span class="o">=</span><span class="nb">T</span><span class="p">)</span><span class="w">
</span><span class="n">lidares</span><span class="o">&lt;-</span><span class="n">readLAScatalog</span><span class="p">(</span><span class="n">archivos</span><span class="p">)</span><span class="w">

</span><span class="c1"># Load plots data</span><span class="w">
</span><span class="n">ptos</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.csv</span><span class="p">(</span><span class="s2">"Data/Plots.csv"</span><span class="p">)</span></code></pre></figure>

<p>Since <code class="language-plaintext highlighter-rouge">ptos</code> is a csv table, first we need to transform it to an sf object and then project it in the same crs as the LiDAR data (EPSG:32615). So lets do that by first indicating the crs in which the coordinates in the original table are and then transforming them to the target EPSG and then create a buffer of radius = 10 m. We also can select only the columns of interest and rename it.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">ptos</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">st_as_sf</span><span class="p">(</span><span class="n">ptos</span><span class="p">,</span><span class="w"> 
                  </span><span class="n">coords</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"Easting_Geo"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Northing_Geo"</span><span class="p">),</span><span class="w">
                  </span><span class="n">crs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4326</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">st_transform</span><span class="p">(</span><span class="m">32615</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">st_buffer</span><span class="p">(</span><span class="m">10</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">select</span><span class="p">(</span><span class="n">Id_parcela</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">rename</span><span class="p">(</span><span class="s2">"PLOT_ID"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Id_parcela"</span><span class="p">)</span></code></pre></figure>

<p>Now, lets check if everything is ok. First, lets run some tests to see if everything is ok.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">las_check</span><span class="p">(</span><span class="n">lidares</span><span class="p">)</span></code></pre></figure>

<p>Now let’s check if both datasets have the same crs and overlap. In this case, I will select a single property of the <code class="language-plaintext highlighter-rouge">sf</code> object named “Id_parcela”.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">plot</span><span class="p">(</span><span class="n">lidares</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">ptos</span><span class="p">[</span><span class="s2">"Id_parcela"</span><span class="p">],</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">)</span></code></pre></figure>

<p>You should see something similar to the following image:</p>

<p style="text-align: center; font-size:0.75em;"><a href="http://localhost:4000/assets/images/yaxlidarptos.png"><img src="http://localhost:4000/assets/images/yaxlidarptos.png" alt="styled-image" class="align-center" style="width: 90%;" /></a> Example of spatial overlap between the liDAR data and field plots.</p>

<p>After making those tests, we are ready to process the data.</p>

<p>Since we are working with a LAScatalog, in order to calculate the metrics of interest we can focus to work with only the places where we have field data (ptos). Thus, we can clip the field data plots to the las catalog. There could be plots that do not fall inside the LiDAR data, so we can filter just to stay with the ones that have LiDAR associated data.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">ext_lidares</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ext</span><span class="p">(</span><span class="n">lidares</span><span class="p">)</span><span class="w">
</span><span class="n">ptos</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">st_crop</span><span class="p">(</span><span class="n">ptos</span><span class="p">,</span><span class="w">
                </span><span class="n">ext_lidares</span><span class="p">)</span></code></pre></figure>

<p>The next step is creating a digital terrain model (DTM) using a knn nearest neighbor algorithm. Here you can select another algorithm such as knnidw, tin and kriging.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">dtm</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rasterize_terrain</span><span class="p">(</span><span class="n">lidares</span><span class="p">,</span><span class="w">
                         </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w">
                         </span><span class="n">algorithm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">knnidw</span><span class="p">(</span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">6L</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">))</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">dtm</span><span class="p">)</span><span class="w">                         </span></code></pre></figure>

<p>Then we can use the DTM to subtract those values to the vegetation points in order to get the vegetation height values. This is usually known as normalization. Here we need to set additional options to process chunks.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># Set output for normalized data, here I will use a files folder</span><span class="w">
</span><span class="n">opt_chunk_size</span><span class="p">(</span><span class="n">lidares</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="w">
</span><span class="n">opt_output_files</span><span class="p">(</span><span class="n">lidares</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w">  </span><span class="n">paste0</span><span class="p">(</span><span class="s2">"files"</span><span class="p">,</span><span class="w"> </span><span class="s2">"/{*}_norm"</span><span class="p">)</span><span class="w">
</span><span class="n">nlas</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">normalize_height</span><span class="p">(</span><span class="n">lidares</span><span class="p">,</span><span class="w"> 
                         </span><span class="n">algorithm</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">tin</span><span class="p">(),</span><span class="w">
                         </span><span class="n">dtm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dtm</span><span class="p">)</span></code></pre></figure>

<p>The next step is to get the point cloud metrics by plot. In this case, we are going to use the default std metrics from z. Here you can set any function using the folowing notation: <code class="language-plaintext highlighter-rouge">~list(q10 = quantile(Z, probs = 0.10),q95 = quantile(Z, probs = 0.95))</code>. Before running the following code, we need to change the options to export the files produced for each plot. Here I will use the pattern “ID” to get each file with a consecutive number.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">opt_output_files</span><span class="p">(</span><span class="n">nlas</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w">  </span><span class="n">paste0</span><span class="p">(</span><span class="s2">"files"</span><span class="p">,</span><span class="w"> </span><span class="s2">"/{ID}"</span><span class="p">)</span><span class="w">
</span><span class="n">metrics</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">plot_metrics</span><span class="p">(</span><span class="n">nlas</span><span class="p">,</span><span class="w"> 
                        </span><span class="n">.stdmetrics_z</span><span class="p">,</span><span class="w">
                        </span><span class="n">ptos</span><span class="p">)</span></code></pre></figure>

<p>Finally, you will obtain a data frame with the plot’s ID and its corresponding z- metrics.</p>]]></content><author><name>Jonathan V. Solórzano</name></author><category term="blog" /><category term="post" /><category term="r" /><category term="LiDAR" /><category term="point cloud" /><category term="raster" /><category term="lidR" /><summary type="html"><![CDATA[Working with LiDAR data in R]]></summary></entry><entry><title type="html">Beautiful-plots(ggplot2)-in-r</title><link href="http://localhost:4000/blog/beautiful-plots(ggplot2)-in-r/" rel="alternate" type="text/html" title="Beautiful-plots(ggplot2)-in-r" /><published>2023-06-22T06:35:00-06:00</published><updated>2023-06-22T06:35:00-06:00</updated><id>http://localhost:4000/blog/beautiful-plots(ggplot2)-in-r</id><content type="html" xml:base="http://localhost:4000/blog/beautiful-plots(ggplot2)-in-r/"><![CDATA[<h1 id="beautiful-plots-in-r-using-ggplot2">Beautiful plots in R using ggplot2</h1>

<p>The purpose of this post is to show how to use the basic syntax of ggplot2, do some of the most common types of plots, as well as some customizations and facets. For this post we are going to use the iris dataset, as well as the skimr and cowplot packages. The first step consists of loading the desired packages, as well as the data and skimming over it. The first section will show some basic plots, while the next ones will show how to customize certain elements of the plots, like color, fill, facets and theme.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">skimr</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">cowplot</span><span class="p">)</span><span class="w">

</span><span class="n">data</span><span class="p">(</span><span class="n">iris</span><span class="p">)</span><span class="w">
</span><span class="n">skim</span><span class="p">(</span><span class="n">iris</span><span class="p">)</span></code></pre></figure>

<p>Then we can start building our different plots.</p>

<h1 id="basic-plots">Basic plots</h1>

<h2 id="scatterplot">Scatterplot</h2>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">iris</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sepal.Length</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sepal.Width</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_point</span><span class="p">()</span></code></pre></figure>

<p style="text-align: center; font-size:0.75em;"><a href="http://localhost:4000/assets/images/scatter.png"><img src="http://localhost:4000/assets/images/scatter.png" alt="styled-image" class="align-center" style="width: 60%;" /></a> Scatterplot.</p>

<h2 id="line-plot">Line plot</h2>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">iris</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sepal.Length</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sepal.Width</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_line</span><span class="p">()</span></code></pre></figure>

<p style="text-align: center; font-size:0.75em;"><a href="http://localhost:4000/assets/images/line.png"><img src="http://localhost:4000/assets/images/line.png" alt="styled-image" class="align-center" style="width: 60%;" /></a> Line plot</p>

<h2 id="bar-plot">Bar plot</h2>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">iris</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Species</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_bar</span><span class="p">()</span></code></pre></figure>

<p style="text-align: center; font-size:0.75em;"><a href="http://localhost:4000/assets/images/bar.png"><img src="http://localhost:4000/assets/images/bar.png" alt="styled-image" class="align-center" style="width: 60%;" /></a> Bar plot.</p>

<h2 id="column-plot">Column plot</h2>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">iris</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">group_by</span><span class="p">(</span><span class="n">Species</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">summarise</span><span class="p">(</span><span class="n">meanSL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">Sepal.Length</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Species</span><span class="p">,</span><span class="w">
             </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">meanSL</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_col</span><span class="p">()</span></code></pre></figure>

<p style="text-align: center; font-size:0.75em;"><a href="http://localhost:4000/assets/images/col.png"><img src="http://localhost:4000/assets/images/col.png" alt="styled-image" class="align-center" style="width: 60%;" /></a> Column plot.</p>

<h2 id="box-plot">Box plot</h2>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">iris</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Species</span><span class="p">,</span><span class="w">
             </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sepal.Length</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_boxplot</span><span class="p">()</span></code></pre></figure>

<p style="text-align: center; font-size:0.75em;"><a href="http://localhost:4000/assets/images/box.png"><img src="http://localhost:4000/assets/images/box.png" alt="styled-image" class="align-center" style="width: 60%;" /></a> Boxplot.</p>

<h2 id="histogram-plot">Histogram plot</h2>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">iris</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
</span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sepal.Length</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_histogram</span><span class="p">()</span></code></pre></figure>

<p style="text-align: center; font-size:0.75em;"><a href="http://localhost:4000/assets/images/hist.png"><img src="http://localhost:4000/assets/images/hist.png" alt="styled-image" class="align-center" style="width: 60%;" /></a> Histogram plot.</p>

<h1 id="adding-colors">Adding colors</h1>

<h2 id="color">Color</h2>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">iris</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sepal.Length</span><span class="p">,</span><span class="w"> 
             </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sepal.Width</span><span class="p">,</span><span class="w">
             </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Species</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_point</span><span class="p">()</span></code></pre></figure>

<p style="text-align: center; font-size:0.75em;"><a href="http://localhost:4000/assets/images/color.png"><img src="http://localhost:4000/assets/images/color.png" alt="styled-image" class="align-center" style="width: 60%;" /></a> Scatterplot with colors by factor.</p>

<h2 id="fill">Fill</h2>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">iris</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Species</span><span class="p">,</span><span class="w">
             </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Species</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_bar</span><span class="p">()</span></code></pre></figure>

<p style="text-align: center; font-size:0.75em;"><a href="http://localhost:4000/assets/images/fill.png"><img src="http://localhost:4000/assets/images/fill.png" alt="styled-image" class="align-center" style="width: 60%;" /></a> Barplot with fill by factor.</p>

<h2 id="customized-colors">Customized colors</h2>

<h3 id="manual-colors">Manual colors</h3>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">iris</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sepal.Length</span><span class="p">,</span><span class="w"> 
             </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sepal.Width</span><span class="p">,</span><span class="w">
             </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Species</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_point</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">scale_colour_manual</span><span class="p">(</span><span class="n">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"forestgreen"</span><span class="p">,</span><span class="w"> </span><span class="s2">"royalblue"</span><span class="p">,</span><span class="w"> </span><span class="s2">"firebrick2"</span><span class="p">))</span></code></pre></figure>

<p style="text-align: center; font-size:0.75em;"><a href="http://localhost:4000/assets/images/manualcol.png"><img src="http://localhost:4000/assets/images/manualcol.png" alt="styled-image" class="align-center" style="width: 60%;" /></a> Scatterplot with manual colors by factor.</p>

<h3 id="rcolorbrewer">Rcolorbrewer</h3>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">iris</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sepal.Length</span><span class="p">,</span><span class="w"> 
             </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sepal.Width</span><span class="p">,</span><span class="w">
             </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Species</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_point</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">scale_colour_brewer</span><span class="p">(</span><span class="n">palette</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"RdYlBu"</span><span class="p">)</span></code></pre></figure>

<p style="text-align: center; font-size:0.75em;"><a href="http://localhost:4000/assets/images/colorbrewer.png"><img src="http://localhost:4000/assets/images/colorbrewer.png" alt="styled-image" class="align-center" style="width: 60%;" /></a> Scatterplots with colors set by RColorbrewer.</p>

<h1 id="axes">Axes</h1>

<h2 id="axes-1">Axes</h2>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">iris</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sepal.Length</span><span class="p">,</span><span class="w"> 
             </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sepal.Width</span><span class="p">,</span><span class="w">
             </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Species</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_point</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">scale_y_continuous</span><span class="p">(</span><span class="n">breaks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">seq</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">4.5</span><span class="p">,</span><span class="w"> </span><span class="m">0.25</span><span class="p">),</span><span class="w">
                     </span><span class="n">limits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">4.5</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">scale_x_continuous</span><span class="p">(</span><span class="n">breaks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">seq</span><span class="p">(</span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="m">8</span><span class="p">,</span><span class="w"> </span><span class="m">0.5</span><span class="p">),</span><span class="w">
                     </span><span class="n">limits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="m">8</span><span class="p">))</span></code></pre></figure>

<p style="text-align: center; font-size:0.75em;"><a href="http://localhost:4000/assets/images/axes.png"><img src="http://localhost:4000/assets/images/axes.png" alt="styled-image" class="align-center" style="width: 60%;" /></a> Scatterplot with customized axes.</p>

<h2 id="axes-labels">Axes labels</h2>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">iris</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sepal.Length</span><span class="p">,</span><span class="w"> 
             </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sepal.Width</span><span class="p">,</span><span class="w">
             </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Species</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_point</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Sepal length (cm)"</span><span class="p">,</span><span class="w"> 
       </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Sepal width (cm)"</span><span class="p">)</span></code></pre></figure>

<p style="text-align: center; font-size:0.75em;"><a href="http://localhost:4000/assets/images/axeslab.png"><img src="http://localhost:4000/assets/images/axeslab.png" alt="styled-image" class="align-center" style="width: 60%;" /></a> Scatterplot with customized axes labels.</p>

<h1 id="facets">Facets</h1>

<h2 id="facet-grid">Facet grid</h2>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">iris</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sepal.Length</span><span class="p">,</span><span class="w"> 
             </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sepal.Width</span><span class="p">,</span><span class="w">
             </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Species</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_point</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">facet_grid</span><span class="p">(</span><span class="o">~</span><span class="w"> </span><span class="n">Species</span><span class="p">)</span></code></pre></figure>

<p style="text-align: center; font-size:0.75em;"><a href="http://localhost:4000/assets/images/facetgrid.png"><img src="http://localhost:4000/assets/images/facetgrid.png" alt="styled-image" class="align-center" style="width: 60%;" /></a> Scatterplot with facets set as a grid.</p>

<h2 id="facet-wrap">Facet wrap</h2>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">iris</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sepal.Length</span><span class="p">,</span><span class="w"> 
             </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sepal.Width</span><span class="p">,</span><span class="w">
             </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Species</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_point</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">facet_grid</span><span class="p">(</span><span class="o">~</span><span class="w"> </span><span class="n">Species</span><span class="p">)</span></code></pre></figure>

<p style="text-align: center; font-size:0.75em;"><a href="http://localhost:4000/assets/images/facetwrap.png"><img src="http://localhost:4000/assets/images/facetwrap.png" alt="styled-image" class="align-center" style="width: 60%;" /></a> Scatterplot with facets set as a wrap (multiple factors will be accumulated by each panel).</p>

<h1 id="theme">Theme</h1>

<h2 id="personalized-theme">Personalized theme</h2>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">my_theme</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">theme_bw</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">theme</span><span class="p">(</span><span class="n">plot.title</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">18</span><span class="p">,</span><span class="n">hjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">),</span><span class="w">
        </span><span class="n">text</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">24</span><span class="p">,</span><span class="n">colour</span><span class="o">=</span><span class="s2">"black"</span><span class="p">),</span><span class="w">
        </span><span class="n">axis.text.x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">18</span><span class="p">,</span><span class="w">
                                   </span><span class="n">colour</span><span class="o">=</span><span class="s2">"black"</span><span class="p">,</span><span class="w">
                                   </span><span class="n">angle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">90</span><span class="p">,</span><span class="w"> 
                                   </span><span class="n">hjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w">
                                   </span><span class="n">vjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">),</span><span class="w">
        </span><span class="n">axis.text.y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">18</span><span class="p">,</span><span class="w">
                                   </span><span class="n">colour</span><span class="o">=</span><span class="s2">"black"</span><span class="p">,</span><span class="w">
                                   </span><span class="n">angle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> 
                                   </span><span class="n">vjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">,</span><span class="w">
                                   </span><span class="n">hjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">),</span><span class="w">
        </span><span class="n">axis.title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">18</span><span class="p">,</span><span class="w">
                                  </span><span class="n">colour</span><span class="o">=</span><span class="s2">"black"</span><span class="p">,</span><span class="w">
                                  </span><span class="n">face</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"bold"</span><span class="p">),</span><span class="w"> 
        </span><span class="n">axis.line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_line</span><span class="p">(</span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"black"</span><span class="p">),</span><span class="w">
        </span><span class="n">legend.title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">18</span><span class="p">),</span><span class="w">
        </span><span class="n">legend.text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">18</span><span class="p">),</span><span class="w">
        </span><span class="n">axis.line.x</span><span class="w"> </span><span class="o">=</span><span class="n">element_line</span><span class="p">(</span><span class="n">colour</span><span class="o">=</span><span class="s2">"black"</span><span class="p">),</span><span class="w">
        </span><span class="n">axis.line.y</span><span class="w"> </span><span class="o">=</span><span class="n">element_line</span><span class="p">(</span><span class="n">colour</span><span class="o">=</span><span class="s2">"black"</span><span class="p">),</span><span class="w">
        </span><span class="n">panel.grid.major</span><span class="o">=</span><span class="n">element_blank</span><span class="p">(),</span><span class="w">
        </span><span class="n">panel.grid.minor</span><span class="o">=</span><span class="n">element_blank</span><span class="p">(),</span><span class="w">
        </span><span class="n">panel.border</span><span class="o">=</span><span class="n">element_blank</span><span class="p">(),</span><span class="w">
        </span><span class="n">panel.background</span><span class="o">=</span><span class="n">element_blank</span><span class="p">(),</span><span class="w">
        </span><span class="n">strip.background</span><span class="w"> </span><span class="o">=</span><span class="n">element_rect</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="s2">"gray90"</span><span class="p">,</span><span class="w">
                                       </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"black"</span><span class="p">),</span><span class="w">
        </span><span class="n">strip.text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">18</span><span class="p">,</span><span class="w">
                                  </span><span class="n">colour</span><span class="o">=</span><span class="s2">"black"</span><span class="p">,</span><span class="w">
                                  </span><span class="n">face</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"bold"</span><span class="p">),</span><span class="w">
        </span><span class="n">plot.margin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unit</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">0.01</span><span class="p">,</span><span class="m">0.01</span><span class="p">,</span><span class="m">0.01</span><span class="p">,</span><span class="m">0.01</span><span class="p">),</span><span class="w"> </span><span class="s2">"cm"</span><span class="p">))</span><span class="w">

</span><span class="n">iris</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sepal.Length</span><span class="p">,</span><span class="w"> 
             </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sepal.Width</span><span class="p">,</span><span class="w">
             </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Species</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_point</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">facet_wrap</span><span class="p">(</span><span class="o">~</span><span class="w"> </span><span class="n">Species</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">my_theme</span></code></pre></figure>

<p style="text-align: center; font-size:0.75em;"><a href="http://localhost:4000/assets/images/mytheme.png"><img src="http://localhost:4000/assets/images/mytheme.png" alt="styled-image" class="align-center" style="width: 60%;" /></a> Scatterplot with facet wrap where several theme elements have been customized according to personal criteria.</p>

<h2 id="cowplot-theme">Cowplot theme</h2>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">iris</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sepal.Length</span><span class="p">,</span><span class="w"> 
             </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sepal.Width</span><span class="p">,</span><span class="w">
             </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Species</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_point</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">facet_wrap</span><span class="p">(</span><span class="o">~</span><span class="w"> </span><span class="n">Species</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">theme_cowplot</span><span class="p">()</span></code></pre></figure>

<p style="text-align: center; font-size:0.75em;"><a href="http://localhost:4000/assets/images/cowplottheme.png"><img src="http://localhost:4000/assets/images/cowplottheme.png" alt="styled-image" class="align-center" style="width: 60%;" /></a> Scatterplot with facet wrap where several theme elements have been customized according to the cowplot theme.</p>]]></content><author><name>Jonathan V. Solórzano</name></author><category term="blog" /><category term="post" /><category term="r" /><category term="ggplot2" /><category term="plot" /><category term="grammar of graphics" /><category term="figures" /><summary type="html"><![CDATA[Beautiful plots in R using ggplot2]]></summary></entry><entry><title type="html">Web scraping with r</title><link href="http://localhost:4000/blog/web-scraping-with-r/" rel="alternate" type="text/html" title="Web scraping with r" /><published>2023-06-09T12:19:00-06:00</published><updated>2023-06-09T12:19:00-06:00</updated><id>http://localhost:4000/blog/web-scraping-with-r</id><content type="html" xml:base="http://localhost:4000/blog/web-scraping-with-r/"><![CDATA[<h1 id="web-scraping-with-r">Web scraping with R</h1>

<p>This post will show you how to get data from a webpage (also known as web scraping) with R and the rvest package. This analysis was performed to complement the data obtained from the spotify API. Since I could not obtain all the data I was interested in from the latter API, I decided to web scrape the bandcamp site.</p>

<p>The first thing is to load the necessary packages: rvest for the webscraping and purrr for making loops.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="n">rvest</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">purrr</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">stringr</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">tibble</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">tidyr</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span></code></pre></figure>

<p>Then, indicate the website of interest. In this case, bandcamp.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">site_url</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"https://bandcamp.com/"</span></code></pre></figure>

<p>Here is the dataframe I am going to use to consult the data from bandcamp.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">nogenre</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">structure</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">artist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"Discipline"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Back from the Futer"</span><span class="p">,</span><span class="w"> 
</span><span class="s2">"La Plante Sauvage"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Quella Vecchia Locanda"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Daal"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Bobby Prince"</span><span class="p">,</span><span class="w"> 
</span><span class="s2">"Greco Bastian"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Wayfarer"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Flub"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Schizofrnatik"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Endolith"</span><span class="p">,</span><span class="w"> 
</span><span class="s2">"Energetic Mind"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Thanatopsis"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Mary Halvorson Octet"</span><span class="p">,</span><span class="w"> </span><span class="s2">"4 ciénegas"</span><span class="w">
</span><span class="p">),</span><span class="w"> </span><span class="n">album</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"Unfolded Like Staircase"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Aavikko"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Alain Goraguer"</span><span class="p">,</span><span class="w"> 
</span><span class="s2">"Quella Vecchia Locanda"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Decalgue of Darkness"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Doom 2 OST"</span><span class="p">,</span><span class="w"> 
</span><span class="s2">"Greco Bastian"</span><span class="p">,</span><span class="w"> </span><span class="s2">"A Romance with Violence"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Flub"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Funk From Hell"</span><span class="p">,</span><span class="w"> 
</span><span class="s2">"Voyager"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Bonniesongs"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Requiem"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Away With You"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Cuatro ciénegas"</span><span class="w">
</span><span class="p">),</span><span class="w"> </span><span class="n">genre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="kc">NA_character_</span><span class="p">,</span><span class="w"> </span><span class="kc">NA_character_</span><span class="p">,</span><span class="w"> </span><span class="kc">NA_character_</span><span class="p">,</span><span class="w"> </span><span class="kc">NA_character_</span><span class="p">,</span><span class="w"> 
</span><span class="kc">NA_character_</span><span class="p">,</span><span class="w"> </span><span class="kc">NA_character_</span><span class="p">,</span><span class="w"> </span><span class="kc">NA_character_</span><span class="p">,</span><span class="w"> </span><span class="kc">NA_character_</span><span class="p">,</span><span class="w"> </span><span class="kc">NA_character_</span><span class="p">,</span><span class="w"> 
</span><span class="kc">NA_character_</span><span class="p">,</span><span class="w"> </span><span class="kc">NA_character_</span><span class="p">,</span><span class="w"> </span><span class="kc">NA_character_</span><span class="p">,</span><span class="w"> </span><span class="kc">NA_character_</span><span class="p">,</span><span class="w"> </span><span class="kc">NA_character_</span><span class="p">,</span><span class="w"> 
</span><span class="kc">NA_character_</span><span class="p">),</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="kc">NA</span><span class="p">,</span><span class="w"> </span><span class="kc">NA</span><span class="p">,</span><span class="w"> </span><span class="kc">NA</span><span class="p">,</span><span class="w"> </span><span class="kc">NA</span><span class="p">,</span><span class="w"> </span><span class="kc">NA</span><span class="p">,</span><span class="w"> </span><span class="s2">"https://www.youtube.com/watch?v=OyHqGSO67wo"</span><span class="p">,</span><span class="w"> 
</span><span class="kc">NA</span><span class="p">,</span><span class="w"> </span><span class="kc">NA</span><span class="p">,</span><span class="w"> </span><span class="kc">NA</span><span class="p">,</span><span class="w"> </span><span class="kc">NA</span><span class="p">,</span><span class="w"> </span><span class="kc">NA</span><span class="p">,</span><span class="w"> </span><span class="kc">NA</span><span class="p">,</span><span class="w"> </span><span class="kc">NA</span><span class="p">,</span><span class="w"> </span><span class="kc">NA</span><span class="p">,</span><span class="w"> </span><span class="kc">NA</span><span class="p">)),</span><span class="w"> </span><span class="n">row.names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">37L</span><span class="p">,</span><span class="w"> </span><span class="m">13L</span><span class="p">,</span><span class="w"> 
</span><span class="m">77L</span><span class="p">,</span><span class="w"> </span><span class="m">113L</span><span class="p">,</span><span class="w"> </span><span class="m">32L</span><span class="p">,</span><span class="w"> </span><span class="m">19L</span><span class="p">,</span><span class="w"> </span><span class="m">60L</span><span class="p">,</span><span class="w"> </span><span class="m">151L</span><span class="p">,</span><span class="w"> </span><span class="m">54L</span><span class="p">,</span><span class="w"> </span><span class="m">121L</span><span class="p">,</span><span class="w"> </span><span class="m">49L</span><span class="p">,</span><span class="w"> </span><span class="m">50L</span><span class="p">,</span><span class="w"> </span><span class="m">137L</span><span class="p">,</span><span class="w"> </span><span class="m">95L</span><span class="p">,</span><span class="w"> 
</span><span class="m">2L</span><span class="p">),</span><span class="w"> </span><span class="n">class</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"data.frame"</span><span class="p">)</span></code></pre></figure>

<p>The next step is creating a function that will be used to make the search in bandcamp. Some additional tweaks had to be made so that the function worked. Most of this part was defined by playing with the bandcamp’s search bar and annotating how the url of the search was processed. Then, you need to inspect the web page to see the names of the sections you are interested in extracting. Finally, I just made some data wragnling to clean the data and export it more homogeneously.</p>

<p>The main functions for webscraping with rvest are <code class="language-plaintext highlighter-rouge">read_html</code>, <code class="language-plaintext highlighter-rouge">html_node</code> and <code class="language-plaintext highlighter-rouge">html_text</code>. The first one enables reading the html code of the indicated url. The second one enables extracting one node or section of this web page and finally, the third one converts the extracted object into text.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">rvest_func</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">){</span><span class="w">
  </span><span class="n">band_orig</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">x</span><span class="w">
  </span><span class="c1"># These substitutions were based on trial and error on the bandcamp website.</span><span class="w">
  </span><span class="c1"># Substitute spaces by + sign to work with the syntax used to search for terms with more than one word.</span><span class="w">
  </span><span class="n">band</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">gsub</span><span class="p">(</span><span class="s2">"\\s"</span><span class="p">,</span><span class="w"> </span><span class="s2">"+"</span><span class="p">,</span><span class="w"> </span><span class="n">band_orig</span><span class="p">)</span><span class="w">
  </span><span class="c1"># Transform ñ into the translation made in the search bar</span><span class="w">
  </span><span class="n">band</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">gsub</span><span class="p">(</span><span class="s2">"ñ"</span><span class="p">,</span><span class="w"> </span><span class="s2">"%C3%B1"</span><span class="p">,</span><span class="w"> </span><span class="n">band</span><span class="p">)</span><span class="w">
  </span><span class="c1"># Set the url to search for a particular band</span><span class="w">
  </span><span class="n">url_sub2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">paste0</span><span class="p">(</span><span class="s1">'search?q='</span><span class="p">,</span><span class="n">band</span><span class="p">,</span><span class="s1">'&amp;item_type'</span><span class="p">)</span><span class="w">
  
  </span><span class="c1"># build the url to be scraped by combining the site url with the band url</span><span class="w">
  </span><span class="n">df1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">paste0</span><span class="p">(</span><span class="n">site_url</span><span class="p">,</span><span class="w"> </span><span class="n">url_sub2</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
    </span><span class="c1"># scrape the html</span><span class="w">
    </span><span class="n">read_html</span><span class="p">()</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
    </span><span class="c1"># Inspect the web page to see which sections are available and select the name of the one of interest</span><span class="w">
    </span><span class="n">html_node</span><span class="p">(</span><span class="s1">'.result-info'</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="c1"># Get the entries of interes</span><span class="w">
    </span><span class="n">html_node</span><span class="p">(</span><span class="s1">'.tags.data-search'</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="c1"># Retrieve the data as text</span><span class="w">
    </span><span class="n">html_text</span><span class="p">()</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="c1"># Replace new lines for nothing</span><span class="w">
    </span><span class="n">str_replace_all</span><span class="p">(</span><span class="s2">"\n"</span><span class="p">,</span><span class="w"> </span><span class="s2">""</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="c1"># Remove the tag "tags:"</span><span class="w">
    </span><span class="n">str_replace_all</span><span class="p">(</span><span class="s2">"tags: "</span><span class="p">,</span><span class="w"> </span><span class="s2">""</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="c1"># Substitute multiple spaces for a single one</span><span class="w">
    </span><span class="n">str_replace_all</span><span class="p">(</span><span class="s2">"\\s+"</span><span class="p">,</span><span class="w"> </span><span class="s2">" "</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="c1"># Remove spaces between commas, ^ or at the end of the string</span><span class="w">
    </span><span class="n">str_replace_all</span><span class="p">(</span><span class="s2">"(?&lt;=\\,)\\s+|^\\s+|\\s+$"</span><span class="p">,</span><span class="w"> </span><span class="s2">""</span><span class="p">)</span><span class="w">
  
  </span><span class="c1"># Separate each genre into its own column</span><span class="w">
  </span><span class="n">df1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">separate_wider_delim</span><span class="p">(</span><span class="n">tibble</span><span class="p">(</span><span class="n">genre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df1</span><span class="p">),</span><span class="w"> 
                              </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">genre</span><span class="p">,</span><span class="w"> 
                              </span><span class="n">delim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">","</span><span class="p">,</span><span class="w">
                              </span><span class="n">names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">paste0</span><span class="p">(</span><span class="s2">"genre"</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">20</span><span class="p">),</span><span class="w">
                              </span><span class="n">too_few</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"align_start"</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="c1"># Transform data into long format</span><span class="w">
    </span><span class="n">pivot_longer</span><span class="p">(</span><span class="n">everything</span><span class="p">(),</span><span class="w">
                 </span><span class="n">names_to</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"name"</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="c1"># Drop NA entries </span><span class="w">
    </span><span class="n">drop_na</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="c1"># Select the value column</span><span class="w">
    </span><span class="n">select</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="c1"># Rename</span><span class="w">
    </span><span class="n">rename</span><span class="p">(</span><span class="s2">"genre"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"value"</span><span class="p">)</span><span class="w">
  
  </span><span class="c1"># Return a tibble with the band name and genres extracted from bandcamp</span><span class="w">
  </span><span class="n">resul</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">tibble</span><span class="p">(</span><span class="n">artist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">rep</span><span class="p">(</span><span class="n">band_orig</span><span class="p">,</span><span class="w"> </span><span class="n">nrow</span><span class="p">(</span><span class="n">df1</span><span class="p">)),</span><span class="w">
                  </span><span class="n">genre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df1</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">pull</span><span class="p">(</span><span class="n">genre</span><span class="p">))</span><span class="w">
  </span><span class="nf">return</span><span class="p">(</span><span class="n">resul</span><span class="p">)</span><span class="w">
  </span><span class="p">}</span></code></pre></figure>

<p>Use map to apply the functino to each artist. Use possibly as a TryCatch; thus, if no genre was found for certain artist it will return the message “Error in file”.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">resul_exp_nogenre</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">map</span><span class="p">(</span><span class="n">nogenre</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
                             </span><span class="n">pull</span><span class="p">(</span><span class="n">artist</span><span class="p">),</span><span class="w"> 
                         </span><span class="n">possibly</span><span class="p">(</span><span class="n">rvest_func</span><span class="p">,</span><span class="w"> 
                                  </span><span class="n">otherwise</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Error in file"</span><span class="p">))</span></code></pre></figure>

<p>Then add the genres as a new column to the previous dataframe and add a counter (llist) that indicates how many genres were associated with each artist.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">prenogenre</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">nogenre</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="c1"># Add the list with extracted genres to the original df</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">lista</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">resul_exp_nogenre</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="c1"># Set a value that indicates if no genres were found for certain artits.</span><span class="w">
  </span><span class="c1"># Put 0 if that is the case (using the possibly) or the number of genres found</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">llist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">map</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">resul_exp_nogenre</span><span class="p">),</span><span class="w"> </span><span class="n">possibly</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">i</span><span class="p">){</span><span class="w">
    </span><span class="n">nrow</span><span class="p">(</span><span class="n">resul_exp_nogenre</span><span class="p">[[</span><span class="n">i</span><span class="p">]])</span><span class="w">
  </span><span class="p">},</span><span class="w"> </span><span class="n">otherwise</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">)))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="c1"># unnest, extract elements from list.</span><span class="w">
  </span><span class="n">unnest</span><span class="p">(</span><span class="n">llist</span><span class="p">)</span><span class="w"> </span></code></pre></figure>

<p>Then eliminate entries without a genre, and unnest the genres list. Obtain the final data frame.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">nogenreFill</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">prenogenre</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="c1"># Eliminate artist for which no genre was found</span><span class="w">
  </span><span class="n">filter</span><span class="p">(</span><span class="n">llist</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="c1"># Unnest  lista column</span><span class="w">
  </span><span class="n">unnest</span><span class="p">(</span><span class="n">lista</span><span class="p">,</span><span class="w">
         </span><span class="n">names_repair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"universal"</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="c1"># Rename column names</span><span class="w">
  </span><span class="n">rename</span><span class="p">(</span><span class="s2">"artist"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"artist...1"</span><span class="p">,</span><span class="w">
         </span><span class="s2">"genre"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"genre...6"</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="c1"># Select columns of interest.</span><span class="w">
  </span><span class="n">select</span><span class="p">(</span><span class="n">artist</span><span class="p">,</span><span class="w"> </span><span class="n">album</span><span class="p">,</span><span class="w"> </span><span class="n">genre</span><span class="p">,</span><span class="w"> </span><span class="n">url</span><span class="p">)</span></code></pre></figure>

<p>A snapshot of the result:</p>

<p style="text-align: center; font-size:0.75em;"><a href="http://localhost:4000/assets/images/rvesttable.png"><img src="http://localhost:4000/assets/images/rvesttable.png" alt="styled-image" class="align-center" style="width: 90%;" /></a> Example of the data obtained after web scraping the bandcamp site.</p>]]></content><author><name>Jonathan V. Solórzano</name></author><category term="blog" /><category term="post" /><category term="r" /><category term="rvest" /><category term="web scraping" /><category term="website data extraction" /><summary type="html"><![CDATA[Web scraping with R]]></summary></entry><entry><title type="html">Open Foris tools in r</title><link href="http://localhost:4000/blog/open-foris-tools/" rel="alternate" type="text/html" title="Open Foris tools in r" /><published>2023-06-09T12:19:00-06:00</published><updated>2023-06-09T12:19:00-06:00</updated><id>http://localhost:4000/blog/open-foris-tools</id><content type="html" xml:base="http://localhost:4000/blog/open-foris-tools/"><![CDATA[<h1 id="open-foris-tools-in-r">Open Foris tools in R</h1>

<p>In this post I will show you how to easily run two Open Foris tools in R to easily validate a map and obtain the area estimates corrected by the producer’s accuracies obtained in the confusion matrix. The repository of these tools can be found here: https://github.com/openforis/accuracy-assessment</p>

<p>There are several ways you can run the apps; however the easiest is to run the shiny app directly from the github repo.</p>

<h2 id="design">Design</h2>

<p>First, we will explore the design app.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="n">shiny</span><span class="p">)</span><span class="w">
</span><span class="n">options</span><span class="p">(</span><span class="n">shiny.launch.browser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
</span><span class="n">runGitHub</span><span class="p">(</span><span class="s2">"openforis/accuracy-assessment"</span><span class="p">,</span><span class="n">subdir</span><span class="o">=</span><span class="s2">"aa_design"</span><span class="p">)</span></code></pre></figure>

<p>Once you open R and run the previous code, you should see the following screen.</p>

<p style="text-align: center; font-size:0.75em;"><a href="http://localhost:4000/assets/images/of1.png"><img src="http://localhost:4000/assets/images/of1.png" alt="styled-image" class="align-center" style="width: 90%;" /></a> Open Foris design app</p>

<h2 id="map-input">Map input</h2>

<p>In this app, you will see in the left panel several submenus. The first one is the Map input, where you can load your classification. Once your image is loaded, go to the next submenu, Strata areas.</p>

<h2 id="strata-areas">Strata areas</h2>

<p>In this menu, the first option will read: area calculation and legend generation. Click here and wait several seconds until the menu that is under this one (Legend labeling) appears with the values of the raster. Here you can change the raster values for a description of that class. For example, Class name 1 could be water, class name 2, forest, etc. Once the descriptions have been added, click on submit legend. Once the legend is submitted the panel on the upper right side should appear with the names of the classes and its area in a table. You can download that table as a csv. Then go to the next submenu: Strata selection.</p>

<h2 id="strata-selection">Strata selection</h2>

<p>Here you set the expected user’s accuracy for each class. Commonly the high value is set for common classes and the low value for rare classes. Once you select the high and low expected user’s accuracy in the sliders, in the lower right panel select the confidence values for each class. Click on the empty spaces and select each class in its corresponding high or low value.</p>

<h2 id="sampling-size">Sampling size</h2>

<p>The next step is selecting the sample size to obtain a desired standard error of the overall accuracy of the map. Here you can select the target standard error (default value = 0.01) and the minimum sample size per strata (default value = 100). A smaller standard error will imply a higher number of points, while the minimum sample size is sometimes recommended of being around 50. If the panel on the right does not adjust its estimates once you change the values in the first panel, verify that the modify the sampling size button is turned off.</p>

<h2 id="sample-allocation">Sample allocation</h2>

<p>Finally, you just need to generate the sampling points by clicking in the button of the final menu. Here a vector file will be generated with the areas to be verified to get the accuracy of the map. Here you can set the size of the intepretation box (min 30 m). Once the points are generated (after several seconds) a map will appear showing the generated points and a new submenu will appear to download the points in the format you desire.</p>

<h1 id="analysis">Analysis</h1>

<p>The second app can be run by using the following code:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="n">shiny</span><span class="p">)</span><span class="w">
</span><span class="n">options</span><span class="p">(</span><span class="n">shiny.launch.browser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
</span><span class="n">runGitHub</span><span class="p">(</span><span class="s2">"openforis/accuracy-assessment"</span><span class="p">,</span><span class="n">subdir</span><span class="o">=</span><span class="s2">"aa_analysis"</span><span class="p">)</span></code></pre></figure>

<p style="text-align: center; font-size:0.75em;"><a href="http://localhost:4000/assets/images/of2.png"><img src="http://localhost:4000/assets/images/of2.png" alt="styled-image" class="align-center" style="width: 90%;" /></a> Open Foris analysis app</p>

<p>Once you see this window in your web browser, you can click on the first submenu: Inputs.</p>

<h2 id="inputs">Inputs</h2>

<p>Here you should add the csv file that contains the data for each validation points generated in the previous app. However this file has been verified an thus, it should contain one column indicating the reference data (by ground truth or visual interpretation) and the original map data (the classification). Afterward, you should add a csv file containing the area data by class (generated in the previous app).</p>

<p>Once you add the two files, a new panel will appear on the right side. Here you should indicate which column has the reference data (by ground truth or visual interpretation) and which one the map class. Also, indicate the columns in the area file indicating the area and the class.</p>

<h2 id="check">Check</h2>

<p>Here you can check the spatial distribution of your verification data. Here you just need to indicate the columns containing the x and y coordinates data.</p>

<h2 id="results">Results</h2>

<p>Here you can see the confusion matrix from your data. Also, in the lower part you can set the desired confidence interval for the area estimates (by default 95 %). Finally. the corrected area estimates should appear in the right panel. In the last test I made with this app, this last part had a bug; thus, I suggest cloning the repo and running it locally as a shiny app. In this last approach, you need to open the app_analysis_bckup_20161024 file inside the Rscript folder and run eveything from start to end. Finally, this way the app should work without any error showing that the names in the two files (1) reference and map classes and 2) areas) do not match.</p>]]></content><author><name>Jonathan V. Solórzano</name></author><category term="blog" /><category term="post" /><category term="r" /><category term="Open Foris" /><category term="map" /><category term="accuracy assessment" /><category term="area estimates" /><category term="map verification" /><category term="map validation" /><category term="overall accuracy" /><summary type="html"><![CDATA[Open Foris tools in R]]></summary></entry><entry><title type="html">Shiny App with spatial data</title><link href="http://localhost:4000/blog/shiny-app-spatial/" rel="alternate" type="text/html" title="Shiny App with spatial data" /><published>2023-05-31T10:19:00-06:00</published><updated>2023-05-31T10:19:00-06:00</updated><id>http://localhost:4000/blog/shiny-app-spatial</id><content type="html" xml:base="http://localhost:4000/blog/shiny-app-spatial/"><![CDATA[<h1 id="shiny-app-with-spatial-data">Shiny App with spatial data</h1>

<p>This post will show you how to build a shiny app to visualize spatial data (mainly in raster and vector format). Remember that you can also build other types of shiny apps, but I decided to focus this post on spatial data.</p>

<p>So the first thing is going to open RStudio, click on New Project -&gt; New Project -&gt; Shiny application and create new shiny app folder.</p>

<p>The first thing is to load the necessary packages</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="n">shiny</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">raster</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">leaflet</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">sf</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">RColorBrewer</span><span class="p">)</span></code></pre></figure>

<p>Then you are going to load the raster and vector data.
Additionally, you need to create a palette to show the DEM we loaded and set customized icons to show the vector data. Finally, you will create the legend entries for each of the customized icons.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># Load the raster and vector data</span><span class="w">
</span><span class="n">sitios</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">st_read</span><span class="p">(</span><span class="s2">"Data/SitiosPtsAll.gpkg"</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">st_transform</span><span class="p">(</span><span class="m">4326</span><span class="p">)</span><span class="w">
</span><span class="n">barrancas</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">st_read</span><span class="p">(</span><span class="s2">"Data/BarrancasAll.gpkg"</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">st_transform</span><span class="p">(</span><span class="m">4326</span><span class="p">)</span><span class="w">
</span><span class="n">DEM</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">raster</span><span class="p">(</span><span class="s2">"Data/DEM.tif"</span><span class="p">)</span><span class="w">

</span><span class="c1"># Palette to show DEM</span><span class="w">
</span><span class="n">mypal</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">palette</span><span class="p">(</span><span class="n">gray</span><span class="p">(</span><span class="n">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="n">length.out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="p">)))</span><span class="w">

</span><span class="n">myIcons</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">icons</span><span class="p">(</span><span class="w">
  </span><span class="n">iconUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">case_when</span><span class="p">(</span><span class="n">sitios</span><span class="o">$</span><span class="n">Geositio</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Localidad"</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="s2">"www/house.png"</span><span class="p">,</span><span class="w">
                      </span><span class="n">sitios</span><span class="o">$</span><span class="n">Geositio</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Templo"</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="s2">"www/iglesia.png"</span><span class="p">,</span><span class="w">
                      </span><span class="n">sitios</span><span class="o">$</span><span class="n">Geositio</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Arbol"</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="s2">"www/tree.png"</span><span class="p">,</span><span class="w">
                      </span><span class="n">sitios</span><span class="o">$</span><span class="n">Geositio</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Cerro"</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="s2">"www/peak.png"</span><span class="p">,</span><span class="w">
                      </span><span class="n">sitios</span><span class="o">$</span><span class="n">Geositio</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Paraje"</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="s2">"www/walker.png"</span><span class="p">,</span><span class="w">
                      </span><span class="n">sitios</span><span class="o">$</span><span class="n">Geositio</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Ranchería"</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="s2">"www/hostel.png"</span><span class="p">,</span><span class="w">
                      </span><span class="n">sitios</span><span class="o">$</span><span class="n">Geositio</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Crucero"</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="s2">"www/crossroad.png"</span><span class="p">,</span><span class="w">
                      </span><span class="kc">TRUE</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="s2">"www/circle.png"</span><span class="p">),</span><span class="w">
  </span><span class="n">iconWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">15</span><span class="p">,</span><span class="w"> 
  </span><span class="n">iconHeight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">15</span><span class="p">,</span><span class="w">
  </span><span class="n">iconAnchorX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">7</span><span class="p">,</span><span class="w">
  </span><span class="n">iconAnchorY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">7</span><span class="p">,</span><span class="w">
  </span><span class="n">className</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Sitios"</span><span class="w">
</span><span class="p">)</span><span class="w">

</span><span class="n">html_legend</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s1">'&lt;img src="house.png" height="15" width="15"&gt;Localidad&lt;br&gt;
                &lt;img src="iglesia.png" height="15" width="15"&gt;Templo&lt;br&gt;
                &lt;img src="tree.png" height="15" width="15"&gt;Árbol&lt;br&gt;
                &lt;img src="peak.png" height="15" width="15"&gt;Cerro&lt;br&gt;
                &lt;img src="walker.png" height="15" width="15"&gt;Paraje&lt;br&gt;
                &lt;img src="hostel.png" height="15" width="15"&gt;Ranchería&lt;br&gt;
                &lt;img src="crossroad.png" height="15" width="15"&gt;Crucero&lt;br&gt;
                &lt;img src="circle.png" height="15" width="15"&gt;Otro&lt;br&gt;'</span></code></pre></figure>

<p>Then, you need to set up the users interface. In this case, since we are interested in navigating spatial data, we are using a vertical layout.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># Define the UI for the app</span><span class="w">
</span><span class="n">ui</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">fluidPage</span><span class="p">(</span><span class="w">
  </span><span class="n">titlePanel</span><span class="p">(</span><span class="s2">"Cuilala App"</span><span class="p">),</span><span class="w">
  </span><span class="n">verticalLayout</span><span class="p">(</span><span class="w">
    </span><span class="n">titlePanel</span><span class="p">(</span><span class="s2">"Cuilala información espacial"</span><span class="p">),</span><span class="w">
  </span><span class="p">)</span><span class="w">
</span><span class="p">)</span></code></pre></figure>

<p>Then create below that same script the server side script. Most of this part is setting up the leaflet visualization, adding a basemap (ESRI world imagery), adding the markers (point data), DEM (raster data) and other features (lines data), adding control layers buttons, as well as the legend for our customized icons and a scale bar. Finally, you need to create an observe event to watch for clicks over the markers, to show up their details when clicked.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># Define the server for the app</span><span class="w">
</span><span class="n">server</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">output</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="c1"># Render the map</span><span class="w">
  </span><span class="n">output</span><span class="o">$</span><span class="n">map</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">renderLeaflet</span><span class="p">({</span><span class="w">
    </span><span class="c1"># Create the leaflet map</span><span class="w">
    </span><span class="n">leaflet</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sitios</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">addProviderTiles</span><span class="p">(</span><span class="s1">'Esri.WorldImagery'</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
      </span><span class="c1"># Add markers for vector data</span><span class="w">
      </span><span class="n">addMarkers</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sitios</span><span class="p">,</span><span class="w">
                 </span><span class="n">popup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="n">Nombre</span><span class="p">,</span><span class="w">
                 </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Sitios"</span><span class="p">,</span><span class="w">
                 </span><span class="n">icon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myIcons</span><span class="p">,</span><span class="w">
               </span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="c1"># Add the raster layer</span><span class="w">
      </span><span class="n">addRasterImage</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DEM</span><span class="p">,</span><span class="w">
                     </span><span class="n">colors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mypal</span><span class="p">,</span><span class="w">
                     </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"ngb"</span><span class="p">,</span><span class="w">
                     </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"MDE"</span><span class="p">,</span><span class="w">
                     </span><span class="n">opacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">70</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="c1"># Add polylines layer</span><span class="w">
      </span><span class="n">addPolylines</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">barrancas</span><span class="p">,</span><span class="w">
        </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"royalblue"</span><span class="p">,</span><span class="w">
        </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Barrancas"</span><span class="p">,</span><span class="w">
        </span><span class="n">popup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="n">Nombre</span><span class="w">
      </span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="c1"># Add Layers control (turn on and off)</span><span class="w">
      </span><span class="n">addLayersControl</span><span class="p">(</span><span class="w">
        </span><span class="n">baseGroups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"ESRI Imagery"</span><span class="p">),</span><span class="w">
        </span><span class="n">overlayGroups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"Sitios"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Barrancas"</span><span class="p">,</span><span class="w"> </span><span class="s2">"MDE"</span><span class="p">),</span><span class="w">
        </span><span class="n">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">layersControlOptions</span><span class="p">(</span><span class="n">collapsed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w">
      </span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="c1"># Add legend for custom icons</span><span class="w">
      </span><span class="n">addControl</span><span class="p">(</span><span class="w">
        </span><span class="n">html</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">html_legend</span><span class="p">,</span><span class="w">
        </span><span class="n">position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"bottomleft"</span><span class="w">
      </span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="c1"># Add scale bar</span><span class="w">
      </span><span class="n">addScaleBar</span><span class="p">(</span><span class="n">position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"bottomright"</span><span class="p">,</span><span class="w">
                  </span><span class="n">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scaleBarOptions</span><span class="p">(</span><span class="w">
                    </span><span class="n">maxWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">100</span><span class="p">,</span><span class="w">
                    </span><span class="n">metric</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w">
                    </span><span class="n">imperial</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">,</span><span class="w">
                    </span><span class="n">updateWhenIdle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="w">
                  </span><span class="p">))</span><span class="w">
  </span><span class="p">})</span><span class="w"> 
  
  </span><span class="c1"># Observe event for clicking over a marker and showing details</span><span class="w">
  </span><span class="n">observeEvent</span><span class="p">(</span><span class="n">input</span><span class="o">$</span><span class="n">mapmarker_click</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> 
    </span><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">input</span><span class="o">$</span><span class="n">map_marker_click</span><span class="w"> 
    </span><span class="n">print</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w">
  </span><span class="p">})</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<p>Finally, run the app.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># Run the app</span><span class="w">
</span><span class="n">shinyApp</span><span class="p">(</span><span class="n">ui</span><span class="p">,</span><span class="w"> </span><span class="n">server</span><span class="p">)</span></code></pre></figure>

<p>A snapshot of the result:</p>

<p style="text-align: center; font-size:0.75em;"><a href="http://localhost:4000/assets/images/App.png"><img src="http://localhost:4000/assets/images/App.png" alt="styled-image" class="align-center" style="width: 90%;" /></a> Shiny app to visualize and explore spatial data.</p>

<p>The real results hosted in shinyapps.io: https://jonathanvsv.shinyapps.io/cuilalaapp/</p>]]></content><author><name>Jonathan V. Solórzano</name></author><category term="blog" /><category term="post" /><category term="r" /><category term="shiny" /><category term="app" /><category term="spatial" /><category term="visualization" /><category term="webapp" /><summary type="html"><![CDATA[Shiny App with spatial data]]></summary></entry><entry><title type="html">Spotify API in R</title><link href="http://localhost:4000/blog/spotify-in-r/" rel="alternate" type="text/html" title="Spotify API in R" /><published>2023-04-04T05:02:00-06:00</published><updated>2023-04-04T05:02:00-06:00</updated><id>http://localhost:4000/blog/spotify-in-r</id><content type="html" xml:base="http://localhost:4000/blog/spotify-in-r/"><![CDATA[<h1 id="spotify-api-in-r">Spotify API in R</h1>

<p>This post will show you how to connect to the Spotify API using R and the <code class="language-plaintext highlighter-rouge">spotifyR</code> package. This API enables you to extract data for particular artists or songs from the Spotify database.</p>

<p>The first step is registering in the Spotify Developer App: https://developer.spotify.com/. Once you are registered, you should create a new app. In that new window you only need to give the app a name, and app description and set some redirect URIs. All the other entries you can leave them empty. For example:</p>

<p style="text-align: center; font-size:0.75em;"><a href="http://localhost:4000/assets/images/spotifyDash.png"><img src="http://localhost:4000/assets/images/spotifyDash.png" alt="styled-image" class="align-center" style="width: 60%;" /></a> Example of fields entered in the spotify dashboard.</p>

<p>Then you, just need to open R, load the libraries we are going to use.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="n">spotifyr</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">tidyr</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">readr</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">purrr</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">stringr</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">forcats</span><span class="p">)</span></code></pre></figure>

<p>and then copy the client id and client secret into R and get the access_token.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">Sys.setenv</span><span class="p">(</span><span class="n">SPOTIFY_CLIENT_ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"My-client-id"</span><span class="p">)</span><span class="w">
</span><span class="n">Sys.setenv</span><span class="p">(</span><span class="n">SPOTIFY_CLIENT_SECRET</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"My-client-secret"</span><span class="p">)</span><span class="w">

</span><span class="n">access_token</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">get_spotify_access_token</span><span class="p">()</span></code></pre></figure>

<p>Then you need to read the artist and album database or any other data frame. In this case, I am going to use a small example with some albums I like.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">tibble</span><span class="p">(</span><span class="n">artist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"Warbringer"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Satyricon"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Meshuggah"</span><span class="p">),</span><span class="w">
            </span><span class="n">album</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"Woe to the Vanquished"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Rebel Extravanganza"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Obzen"</span><span class="p">))</span></code></pre></figure>

<p>Then we are going to use <code class="language-plaintext highlighter-rouge">mutate</code> to extract the genre associated with each artist. Since, not all artists have an associated genre (or can be found in spotify), it is advisable to use <code class="language-plaintext highlighter-rouge">possibly</code> to avoid errors if no genre was find in the Spotify database. Then use this function and finally, do some data wrangling to obtain each genre associated with an artist in a single row.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">safer_process_file</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">possibly</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">resul</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">search_spotify</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"artist"</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="n">slice</span><span class="p">(</span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="n">select</span><span class="p">(</span><span class="n">genres</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="n">unnest</span><span class="p">(</span><span class="n">cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">genres</span><span class="p">))</span><span class="w">
  </span><span class="n">ifelse</span><span class="p">(</span><span class="n">nrow</span><span class="p">(</span><span class="n">resul</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="kc">NA</span><span class="p">,</span><span class="w"> </span><span class="n">resul</span><span class="p">)</span><span class="w">
</span><span class="p">},</span><span class="w">
</span><span class="n">otherwise</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="s2">"Error in file"</span><span class="p">))</span><span class="w">

</span><span class="n">resul</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="c1"># slice(1:9) |&gt;</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">genre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">map</span><span class="p">(</span><span class="n">df</span><span class="o">$</span><span class="n">artist</span><span class="p">,</span><span class="w"> </span><span class="n">safer_process_file</span><span class="p">))</span><span class="w">

</span><span class="n">resul_exp</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">resul</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="c1"># slice(377) |&gt;</span><span class="w">
  </span><span class="n">unnest</span><span class="p">(</span><span class="n">cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">genre</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">unnest</span><span class="p">(</span><span class="n">cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">genre</span><span class="p">,</span><span class="w">
         </span><span class="n">keep_empty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">)</span></code></pre></figure>

<p>Finally, you might want to summarise this information into a plot of the most common genres in your df. So we are going to use a circular plot to show this.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># Make counts by genre and arrange by n</span><span class="w">
</span><span class="n">plotter</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">resul_exp</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">group_by</span><span class="p">(</span><span class="n">genre</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">count</span><span class="p">()</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">arrange</span><span class="p">(</span><span class="n">desc</span><span class="p">(</span><span class="n">n</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">ungroup</span><span class="p">()</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">row_number</span><span class="p">())</span><span class="w">

</span><span class="c1"># Based on: https://r-graph-gallery.com/296-add-labels-to-circular-barplot.html</span><span class="w">
</span><span class="c1"># Get the name and the y position of each label</span><span class="w">
</span><span class="n">label_data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">genre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">plotter</span><span class="o">$</span><span class="n">genre</span><span class="p">,</span><span class="w">
                         </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">plotter</span><span class="o">$</span><span class="n">id</span><span class="p">,</span><span class="w">
                         </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">plotter</span><span class="o">$</span><span class="n">n</span><span class="p">)</span><span class="w">

</span><span class="c1"># calculate the ANGLE of the labels</span><span class="w">
</span><span class="n">number_of_bar</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">nrow</span><span class="p">(</span><span class="n">label_data</span><span class="p">)</span><span class="w">
</span><span class="n">angle</span><span class="w"> </span><span class="o">&lt;-</span><span class="w">  </span><span class="m">90</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">360</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">label_data</span><span class="o">$</span><span class="n">id</span><span class="m">-0.5</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="n">number_of_bar</span><span class="w">     </span><span class="c1"># I substract 0.5 because the letter must have the angle of the center of the bars. Not extreme right(1) or extreme left (0)</span><span class="w">

</span><span class="c1"># calculate the alignment of labels: right or left</span><span class="w">
</span><span class="c1"># Left part of the plot labels will have an angle &lt; -90</span><span class="w">
</span><span class="n">label_data</span><span class="o">$</span><span class="n">hjust</span><span class="o">&lt;-</span><span class="n">ifelse</span><span class="p">(</span><span class="n">angle</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">-90</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w">

</span><span class="c1"># flip angle BY to make them readable</span><span class="w">
</span><span class="n">label_data</span><span class="o">$</span><span class="n">angle</span><span class="o">&lt;-</span><span class="n">ifelse</span><span class="p">(</span><span class="n">angle</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">-90</span><span class="p">,</span><span class="w"> </span><span class="n">angle</span><span class="m">+180</span><span class="p">,</span><span class="w"> </span><span class="n">angle</span><span class="p">)</span><span class="w">

</span><span class="c1"># Start the plot</span><span class="w">
</span><span class="n">plotter</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">as.factor</span><span class="p">(</span><span class="n">id</span><span class="p">),</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">n</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">       
  </span><span class="c1"># This add the bars with a purple color</span><span class="w">
  </span><span class="n">geom_bar</span><span class="p">(</span><span class="n">stat</span><span class="o">=</span><span class="s2">"identity"</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="o">=</span><span class="n">alpha</span><span class="p">(</span><span class="s2">"#8b1c61"</span><span class="p">,</span><span class="w"> </span><span class="m">0.7</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="c1"># First parameter: size of inner circle, second one, margins on the outer circle</span><span class="w">
  </span><span class="n">ylim</span><span class="p">(</span><span class="m">-50</span><span class="p">,</span><span class="m">100</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="c1"># Minimal theme</span><span class="w">
  </span><span class="n">theme_minimal</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="c1"># Transform normal bar plot to circular</span><span class="w">
  </span><span class="n">coord_polar</span><span class="p">(</span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="c1"># Add the labels, using the label_data dataframe that we have created before</span><span class="w">
  </span><span class="n">geom_text</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">label_data</span><span class="p">,</span><span class="w">
            </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">id</span><span class="p">,</span><span class="w">
                </span><span class="n">y</span><span class="o">=</span><span class="n">value</span><span class="m">+0.5</span><span class="p">,</span><span class="w"> </span><span class="n">label</span><span class="o">=</span><span class="n">genre</span><span class="p">,</span><span class="w"> </span><span class="n">hjust</span><span class="o">=</span><span class="n">hjust</span><span class="p">),</span><span class="w">
            </span><span class="n">color</span><span class="o">=</span><span class="s2">"black"</span><span class="p">,</span><span class="w">
            </span><span class="n">fontface</span><span class="o">=</span><span class="s2">"bold"</span><span class="p">,</span><span class="w">
            </span><span class="n">alpha</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="w">
            </span><span class="n">size</span><span class="o">=</span><span class="m">2</span><span class="p">,</span><span class="w">
            </span><span class="n">angle</span><span class="o">=</span><span class="w"> </span><span class="n">label_data</span><span class="o">$</span><span class="n">angle</span><span class="p">,</span><span class="w">
            </span><span class="n">inherit.aes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">theme</span><span class="p">(</span><span class="n">plot.margin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">margin</span><span class="p">(</span><span class="m">-3</span><span class="p">,</span><span class="w"> </span><span class="m">-10</span><span class="p">,</span><span class="w"> </span><span class="m">-3</span><span class="p">,</span><span class="w"> </span><span class="m">-10</span><span class="p">,</span><span class="w"> </span><span class="s2">"cm"</span><span class="p">),</span><span class="w">
        </span><span class="n">axis.text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">(),</span><span class="w">
        </span><span class="n">axis.title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">(),</span><span class="w">
        </span><span class="n">panel.grid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">()</span><span class="c1">#,</span><span class="w">
  </span><span class="p">)</span><span class="w">

</span><span class="n">ggsave</span><span class="p">(</span><span class="s2">"genreSimple.png"</span><span class="p">,</span><span class="w">
       </span><span class="n">device</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"pdf"</span><span class="p">,</span><span class="w">
       </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">15</span><span class="p">,</span><span class="w">
       </span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">15</span><span class="p">,</span><span class="w">
       </span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"cm"</span><span class="p">,</span><span class="w">
       </span><span class="n">dpi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">300</span><span class="p">)</span></code></pre></figure>

<p>The result:</p>

<p style="text-align: center; font-size:0.75em;"><a href="http://localhost:4000/assets/images/genreSimple.png"><img src="http://localhost:4000/assets/images/genreSimple.png" alt="styled-image" class="align-center" style="width: 90%;" /></a> Circular bar plot of the genres.</p>

<p>It is pretty obvious I like metal! 🤘</p>]]></content><author><name>Jonathan V. Solórzano</name></author><category term="blog" /><category term="post" /><category term="r" /><category term="spotify" /><category term="music" /><category term="API" /><summary type="html"><![CDATA[Spotify API in R]]></summary></entry><entry><title type="html">Volcanos 3d maps</title><link href="http://localhost:4000/blog/Volcanos-rayshader/" rel="alternate" type="text/html" title="Volcanos 3d maps" /><published>2023-03-09T16:15:00-06:00</published><updated>2023-03-09T16:15:00-06:00</updated><id>http://localhost:4000/blog/Volcanos-rayshader</id><content type="html" xml:base="http://localhost:4000/blog/Volcanos-rayshader/"><![CDATA[<h1 id="volcanos-3d-maps">Volcanos 3d maps</h1>

<p>I have continued playing with <code class="language-plaintext highlighter-rouge">rayshader</code>, <code class="language-plaintext highlighter-rouge">rayvista</code> and <code class="language-plaintext highlighter-rouge">magick</code> packages to make beautiful 3d maps. This post shows the code used to make a 3d map with some of the highest peaks in Mexico, which all have a volcanic origin. Additionally, the area shown in the map is part of the Trans-Mexican Volcanic Belt. The code used to obtain this map is shown in the first section. The second section of the post contains the code used to make the zoom-ins to each volcano, while the third section contains the code used to merge all the images.</p>

<p>First load the required packages.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="n">rayvista</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">rayshader</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">terra</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">sf</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">magrittr</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">magick</span><span class="p">)</span></code></pre></figure>

<p>Load the roi polygon to make the large map and also a geopackage file that contains points with the locations of each volcano, with its name and altitude. Although initially I wanted to label also Sierra Negra peak, it was overlapping with the Pico de Orizaba so I removed it. Then, the coordinates are extracted from that same file, added as columns and then added a color column to indicate the color of the labels (white: for names that overlapped with the rgb composite and black those that did not). Finally, calculate the area to add it in the end as a label. The data used in this example can be downloaded from: https://github.com/JonathanVSV/Ppage2/tree/master/assets/data</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># Zscale for 3d map</span><span class="w">
</span><span class="n">zscale</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">60</span><span class="w">
</span><span class="c1"># Background color for all maps</span><span class="w">
</span><span class="n">bg_col</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"gray60"</span><span class="w">

</span><span class="c1"># ROI</span><span class="w">
</span><span class="n">picos_poly</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">st_read</span><span class="p">(</span><span class="s2">"Data/Picos.gpkg"</span><span class="p">)</span><span class="w">
</span><span class="c1"># Points of each peak with its name and altitude</span><span class="w">
</span><span class="n">picos_names</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">st_read</span><span class="p">(</span><span class="s2">"Data/picos_names.gpkg"</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="c1"># Removed Sierra Negra because was overlapping with Pico de Orizaba</span><span class="w">
  </span><span class="n">filter</span><span class="p">(</span><span class="n">Name</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s2">"Sierra Negra"</span><span class="p">)</span><span class="w">
</span><span class="c1"># Get its coordinates</span><span class="w">
</span><span class="n">coords</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">picos_names</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">st_coordinates</span><span class="p">()</span><span class="w">
</span><span class="c1"># Add the coordinates as another column and add a color column</span><span class="w">
</span><span class="n">picos_names</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">picos_names</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">bind_cols</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"white"</span><span class="p">,</span><span class="w"> </span><span class="s2">"white"</span><span class="p">,</span><span class="w"> </span><span class="s2">"white"</span><span class="p">,</span><span class="w">
                              </span><span class="s2">"white"</span><span class="p">,</span><span class="w"> </span><span class="s2">"black"</span><span class="p">,</span><span class="w"> </span><span class="s2">"black"</span><span class="p">,</span><span class="w"> </span><span class="s2">"white"</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="c1"># Arrange by altitude for the individual volcanos plots</span><span class="w">
  </span><span class="n">arrange</span><span class="p">(</span><span class="n">desc</span><span class="p">(</span><span class="n">Alt</span><span class="p">))</span><span class="w">

 </span><span class="c1"># Calculate area in sq. km </span><span class="w">
</span><span class="n">areasqkm</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">25000</span><span class="w">

</span><span class="c1"># Aprox area without zoom</span><span class="w">
</span><span class="c1"># picos_poly |&gt;</span><span class="w">
  </span><span class="c1"># st_transform(32614) |&gt;</span><span class="w">
  </span><span class="c1"># st_area() |&gt;</span><span class="w">
  </span><span class="c1"># as.numeric() |&gt;</span><span class="w">
  </span><span class="c1"># multiply_by(1/1000000)</span></code></pre></figure>

<p>Then, obtain the RGB data with the DEM.</p>

<h2 id="large-map">Large map</h2>

<p>Obtain rgb composite and DEM data.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">picos</span><span class="o">&lt;-</span><span class="w"> </span><span class="n">plot_3d_vista</span><span class="p">(</span><span class="n">req_area</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">picos_poly</span><span class="p">,</span><span class="w">
                          </span><span class="n">overlay_detail</span><span class="o">=</span><span class="m">10</span><span class="p">,</span><span class="w"> 
                          </span><span class="n">overlay_alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.7</span><span class="p">,</span><span class="w"> 
                          </span><span class="n">elevation_detail</span><span class="o">=</span><span class="m">9</span><span class="p">,</span><span class="w"> 
                          </span><span class="n">show_vista</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">F</span><span class="p">)</span></code></pre></figure>

<p>Then, create the 3d representation and add the labels and save a snapshot of the rendered image.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># Use dem matrix data</span><span class="w">
</span><span class="n">picos</span><span class="o">$</span><span class="n">dem_matrix</span><span class="o">|&gt;</span><span class="w">
  </span><span class="c1"># Add texture</span><span class="w">
  </span><span class="n">add_overlay</span><span class="p">(</span><span class="n">texture_shade</span><span class="p">(</span><span class="n">picos</span><span class="o">$</span><span class="n">dem_matrix</span><span class="p">,</span><span class="w">
                            </span><span class="n">detail</span><span class="o">=</span><span class="m">0.9</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="c1"># Add snowy peaks effect</span><span class="w">
  </span><span class="n">add_overlay</span><span class="p">(</span><span class="n">generate_altitude_overlay</span><span class="p">(</span><span class="n">height_shade</span><span class="p">(</span><span class="n">picos</span><span class="o">$</span><span class="n">dem_matrix</span><span class="p">,</span><span class="w"> 
                                                     </span><span class="n">texture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"white"</span><span class="p">,</span><span class="w">
                                                     </span><span class="n">range</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">5000</span><span class="p">,</span><span class="m">5700</span><span class="p">)),</span><span class="w">
                                        </span><span class="n">picos</span><span class="o">$</span><span class="n">dem_matrix</span><span class="p">,</span><span class="w"> 
                                        </span><span class="n">start_transition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4500</span><span class="p">,</span><span class="w"> 
                                        </span><span class="n">end_transition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5000</span><span class="p">,</span><span class="w"> 
                                        </span><span class="n">lower</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">),</span><span class="w">
              </span><span class="n">alphalayer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">  </span><span class="o">|&gt;</span><span class="w">
  </span><span class="c1"># Add Shadow</span><span class="w">
  </span><span class="n">add_shadow</span><span class="p">(</span><span class="n">ray_shade</span><span class="p">(</span><span class="n">picos</span><span class="o">$</span><span class="n">dem_matrix</span><span class="p">,</span><span class="w"> </span><span class="n">zscale</span><span class="o">=</span><span class="n">zscale</span><span class="p">),</span><span class="w"> </span><span class="m">0.7</span><span class="p">)</span><span class="o">|&gt;</span><span class="w">
  </span><span class="c1"># Add RGB composite</span><span class="w">
  </span><span class="n">add_overlay</span><span class="p">(</span><span class="n">picos</span><span class="o">$</span><span class="n">texture</span><span class="p">,</span><span class="n">rescale_original</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span><span class="o">|&gt;</span><span class="w">
  </span><span class="c1"># Plot 3d</span><span class="w">
  </span><span class="n">plot_3d</span><span class="p">(</span><span class="n">picos</span><span class="o">$</span><span class="n">dem_matrix</span><span class="p">,</span><span class="w"> 
          </span><span class="n">zscale</span><span class="o">=</span><span class="n">zscale</span><span class="p">,</span><span class="w">
          </span><span class="n">windowsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1200</span><span class="p">,</span><span class="w"> 
          </span><span class="n">zoom</span><span class="o">=</span><span class="m">0.17</span><span class="p">,</span><span class="w"> 
          </span><span class="n">phi</span><span class="o">=</span><span class="m">7</span><span class="p">,</span><span class="w"> 
          </span><span class="n">theta</span><span class="o">=</span><span class="m">280</span><span class="p">,</span><span class="w">
          </span><span class="n">background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bg_col</span><span class="p">)</span><span class="w">

</span><span class="c1"># Add labels</span><span class="w">
</span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">nrow</span><span class="p">(</span><span class="n">picos_names</span><span class="p">)){</span><span class="w">
  </span><span class="c1"># color &lt;- "black"</span><span class="w">
  </span><span class="n">render_label</span><span class="p">(</span><span class="n">picos</span><span class="o">$</span><span class="n">dem_matrix</span><span class="p">,</span><span class="w">
               </span><span class="n">long</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">picos_names</span><span class="o">$</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w">
               </span><span class="n">lat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">picos_names</span><span class="o">$</span><span class="n">Y</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w">
               </span><span class="n">zscale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zscale</span><span class="m">+60</span><span class="p">,</span><span class="w">
               </span><span class="n">extent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">attr</span><span class="p">(</span><span class="n">picos</span><span class="o">$</span><span class="n">dem_matrix</span><span class="p">,</span><span class="w"> </span><span class="s2">"extent"</span><span class="p">),</span><span class="w">
               </span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">paste0</span><span class="p">(</span><span class="n">picos_names</span><span class="o">$</span><span class="n">Name</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span><span class="w">
               </span><span class="n">linecolor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">picos_names</span><span class="o">$</span><span class="n">color</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w">
               </span><span class="n">textcolor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">picos_names</span><span class="o">$</span><span class="n">color</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="c1"># Save as png</span><span class="w">
</span><span class="n">render_snapshot</span><span class="p">(</span><span class="n">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Plots/Volcanos_snap.png"</span><span class="p">,</span><span class="w">
                </span><span class="n">software_render</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">F</span><span class="p">,</span><span class="w">
                </span><span class="n">background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bg_col</span><span class="p">)</span></code></pre></figure>

<h2 id="individual-volcanoes">Individual volcanoes</h2>

<p>This section contains the code used to make the zoom-ins to each volcano. It contains basically the same code as the previous sections but obtains the DEM and RGB composite using the location of each volcano. Finally, to make everything more easy, an lapply is used to make the exact same process for each volcano and save the rendered image as a png.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">lapply</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">nrow</span><span class="p">(</span><span class="n">picos_names</span><span class="p">),</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">i</span><span class="p">){</span><span class="w">
  </span><span class="c1"># Get RGB and DEM for each volcano</span><span class="w">
  </span><span class="n">volcano</span><span class="o">&lt;-</span><span class="w"> </span><span class="n">plot_3d_vista</span><span class="p">(</span><span class="w">
    </span><span class="n">lat</span><span class="o">=</span><span class="n">picos_names</span><span class="o">$</span><span class="n">Y</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w">
    </span><span class="n">long</span><span class="o">=</span><span class="n">picos_names</span><span class="o">$</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w">
    </span><span class="n">radius</span><span class="o">=</span><span class="m">10000</span><span class="p">,</span><span class="w">
    </span><span class="n">overlay_detail</span><span class="o">=</span><span class="m">12</span><span class="p">,</span><span class="w"> 
    </span><span class="n">overlay_alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.7</span><span class="p">,</span><span class="w"> 
    </span><span class="n">elevation_detail</span><span class="o">=</span><span class="m">12</span><span class="p">,</span><span class="w"> 
    </span><span class="n">show_vista</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">F</span><span class="p">)</span><span class="w">
  
  </span><span class="c1"># Make similar visualization to the large map</span><span class="w">
  </span><span class="n">volcano</span><span class="o">$</span><span class="n">dem_matrix</span><span class="o">|&gt;</span><span class="w">
    </span><span class="n">add_overlay</span><span class="p">(</span><span class="n">texture_shade</span><span class="p">(</span><span class="n">volcano</span><span class="o">$</span><span class="n">dem_matrix</span><span class="p">,</span><span class="w">
                              </span><span class="n">detail</span><span class="o">=</span><span class="m">0.9</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="c1"># Add RGB composite</span><span class="w">
    </span><span class="n">add_overlay</span><span class="p">(</span><span class="n">volcano</span><span class="o">$</span><span class="n">texture</span><span class="p">,</span><span class="w">
                </span><span class="n">rescale_original</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span><span class="w">
                </span><span class="n">alphalayer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.7</span><span class="p">)</span><span class="o">|&gt;</span><span class="w">
    </span><span class="n">add_overlay</span><span class="p">(</span><span class="n">generate_altitude_overlay</span><span class="p">(</span><span class="n">height_shade</span><span class="p">(</span><span class="n">volcano</span><span class="o">$</span><span class="n">dem_matrix</span><span class="p">,</span><span class="w">
                                                       </span><span class="n">texture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"white"</span><span class="p">,</span><span class="w">
                                                       </span><span class="n">range</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">5000</span><span class="p">,</span><span class="m">5700</span><span class="p">)),</span><span class="w">
                                          </span><span class="n">volcano</span><span class="o">$</span><span class="n">dem_matrix</span><span class="p">,</span><span class="w">
                                          </span><span class="n">start_transition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4500</span><span class="p">,</span><span class="w">
                                          </span><span class="n">end_transition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5000</span><span class="p">,</span><span class="w">
                                          </span><span class="n">lower</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">),</span><span class="w">
                </span><span class="n">alphalayer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.7</span><span class="p">)</span><span class="w">  </span><span class="o">|&gt;</span><span class="w">
    </span><span class="n">plot_3d</span><span class="p">(</span><span class="n">volcano</span><span class="o">$</span><span class="n">dem_matrix</span><span class="p">,</span><span class="w"> 
            </span><span class="n">zscale</span><span class="o">=</span><span class="m">10</span><span class="p">,</span><span class="w">
            </span><span class="n">windowsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1200</span><span class="p">,</span><span class="w"> 
            </span><span class="n">zoom</span><span class="o">=</span><span class="m">0.6</span><span class="p">,</span><span class="w"> 
            </span><span class="n">phi</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="w"> 
            </span><span class="n">theta</span><span class="o">=</span><span class="m">90</span><span class="p">,</span><span class="w">
            </span><span class="n">baseshape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"rectangle"</span><span class="p">,</span><span class="w">
            </span><span class="n">background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bg_col</span><span class="p">)</span><span class="w">
  
  </span><span class="c1"># Save as png          </span><span class="w">
  </span><span class="n">render_snapshot</span><span class="p">(</span><span class="n">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">paste0</span><span class="p">(</span><span class="s2">"Plots/"</span><span class="p">,</span><span class="n">picos_names</span><span class="o">$</span><span class="n">Name</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="s2">"_snap.png"</span><span class="p">),</span><span class="w">
                  </span><span class="n">software_render</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">F</span><span class="p">,</span><span class="w">
                  </span><span class="n">title_position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"north"</span><span class="p">,</span><span class="w">
                  </span><span class="n">title_font</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"sans"</span><span class="p">,</span><span class="w">
                  </span><span class="n">title_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">50</span><span class="p">,</span><span class="w">
                  </span><span class="n">title_text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">paste0</span><span class="p">(</span><span class="n">picos_names</span><span class="o">$</span><span class="n">Name</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> 
                                      </span><span class="s2">"\n"</span><span class="p">,</span><span class="w"> 
                                      </span><span class="n">picos_names</span><span class="o">$</span><span class="n">Alt</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w">
                                      </span><span class="s2">" m amsl"</span><span class="p">),</span><span class="w">
                  </span><span class="n">title_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">100</span><span class="p">),</span><span class="w">
                  </span><span class="n">gravity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"north"</span><span class="p">,</span><span class="w">
                  </span><span class="n">background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bg_col</span><span class="p">)</span><span class="w">
</span><span class="p">})</span></code></pre></figure>

<h2 id="image-composition-and-final-adjustments">Image composition and final adjustments</h2>

<p>Finally, this part makes use of the <code class="language-plaintext highlighter-rouge">magick</code> package to stitch together all the images and add some labels</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># Read the large map image and make some adjustments</span><span class="w">
</span><span class="n">imall</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">image_read</span><span class="p">(</span><span class="s2">"Plots/Volcanos_snap.png"</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="c1"># Make it bigger</span><span class="w">
  </span><span class="n">image_resize</span><span class="p">(</span><span class="s2">"1975"</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="c1"># Add title</span><span class="w">
  </span><span class="n">image_annotate</span><span class="p">(</span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Mexico's Highest Peaks"</span><span class="p">,</span><span class="w"> 
                 </span><span class="n">weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">700</span><span class="p">,</span><span class="w">
                 </span><span class="n">font</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"sans"</span><span class="p">,</span><span class="w"> 
                 </span><span class="n">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"+100+20"</span><span class="p">,</span><span class="w">
                 </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"black"</span><span class="p">,</span><span class="w"> 
                 </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">80</span><span class="p">,</span><span class="w"> 
                 </span><span class="n">gravity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"north"</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="c1"># Add a label of aprox. area shown               </span><span class="w">
  </span><span class="n">image_annotate</span><span class="p">(</span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">paste0</span><span class="p">(</span><span class="s2">"Aprox. area shown: "</span><span class="p">,</span><span class="w"> </span><span class="n">scales</span><span class="o">::</span><span class="n">comma</span><span class="p">(</span><span class="n">areasqkm</span><span class="p">),</span><span class="w"> </span><span class="s2">" km\U00B2"</span><span class="p">),</span><span class="w"> 
                 </span><span class="n">weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">400</span><span class="p">,</span><span class="w">
                 </span><span class="n">font</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"sans"</span><span class="p">,</span><span class="w"> 
                 </span><span class="n">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"+0+10"</span><span class="p">,</span><span class="w">
                 </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"black"</span><span class="p">,</span><span class="w"> 
                 </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">32</span><span class="p">,</span><span class="w"> 
                 </span><span class="n">gravity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"south"</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="c1"># Eliminate empty spaces               </span><span class="w">
  </span><span class="n">image_trim</span><span class="p">()</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="c1"># Add border</span><span class="w">
  </span><span class="n">image_border</span><span class="p">(</span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bg_col</span><span class="p">,</span><span class="w">
               </span><span class="n">geometry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"50x50"</span><span class="p">)</span><span class="w"> 

</span><span class="c1"># Read individual volcanoes images into a list</span><span class="w">
</span><span class="n">imsingle</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lapply</span><span class="p">(</span><span class="n">picos_names</span><span class="o">$</span><span class="n">Name</span><span class="p">,</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">){</span><span class="w">
  </span><span class="n">image_read</span><span class="p">(</span><span class="n">paste0</span><span class="p">(</span><span class="s2">"Plots/"</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="s2">"_snap.png"</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="c1"># Eliminate empty spaces</span><span class="w">
    </span><span class="n">image_trim</span><span class="p">()</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="c1"># Add new border</span><span class="w">
    </span><span class="n">image_border</span><span class="p">(</span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bg_col</span><span class="p">,</span><span class="w">
                 </span><span class="n">geometry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"20x20"</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="c1"># Resize image</span><span class="w">
    </span><span class="n">image_resize</span><span class="p">(</span><span class="s2">"400"</span><span class="p">)</span><span class="w">
</span><span class="p">})</span><span class="w">

</span><span class="c1"># Stack all single volcanos vertically</span><span class="w">
</span><span class="n">stacked_im</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">image_append</span><span class="p">(</span><span class="n">Reduce</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">imsingle</span><span class="p">),</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">)</span><span class="w">

</span><span class="c1"># Stitch horizontally the map and the stacked volcanoes images</span><span class="w">
</span><span class="n">image_append</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="n">imall</span><span class="p">,</span><span class="w"> </span><span class="n">stacked_im</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
</span><span class="c1"># Add color saturation and contrast</span><span class="w">
  </span><span class="n">image_modulate</span><span class="p">(</span><span class="n">brightness</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">150</span><span class="p">,</span><span class="w"> 
                 </span><span class="n">saturation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">130</span><span class="p">,</span><span class="w"> 
                 </span><span class="n">hue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">100</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="c1"># Increase contrast</span><span class="w">
  </span><span class="n">image_contrast</span><span class="p">(</span><span class="n">sharpen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="c1"># Write image</span><span class="w">
  </span><span class="n">image_write</span><span class="p">(</span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Plots/Volcanos_all_final.png"</span><span class="p">,</span><span class="w"> 
              </span><span class="n">format</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"png"</span><span class="p">)</span></code></pre></figure>

<p>The result:</p>

<p style="text-align: center; font-size:0.75em;"><a href="http://localhost:4000/assets/images/Volcanos_all_final.png"><img src="http://localhost:4000/assets/images/Volcanos_all_final.png" alt="styled-image" class="align-center" style="width: 90%;" /></a> Mexico’s highest peaks.</p>

<p>In the final map, the tallest peaks can be appreciated with its labels, as well as a zoom-in to all of them individually (right-side panel). I like to think of the resulting image as a simple infography.</p>]]></content><author><name>Jonathan V. Solórzano</name></author><category term="blog" /><category term="post" /><category term="r" /><category term="rayshader" /><category term="rayvista" /><category term="magick" /><category term="terra" /><category term="3d maps" /><category term="RGB shaded relief" /><category term="DEM" /><category term="Relief" /><summary type="html"><![CDATA[Volcanos 3d maps]]></summary></entry></feed>